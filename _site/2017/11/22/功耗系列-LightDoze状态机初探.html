<h3 id="light-doze">一、Light Doze状态机</h3>

<p><img src="https://xiezeyangcn.github.io/xzyblog.github.io/assets/images/2017-11-22-light-doze-mode/doze_state_n_light.bmp" alt="" /></p>

<h3 id="light-doze-1">二、Light Doze状态切换</h3>

<h4 id="becomeinactiveifappropriatelockedlightinactive">2.1 调用becomeInactiveIfAppropriateLocked方法判断是否允许设备进入LIGHT_INACTIVE状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">becomeInactiveIfAppropriateLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 灭屏&amp;未充电，或强制空闲</span>
        <span class="k">if</span> <span class="o">((!</span><span class="n">mScreenOn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mCharging</span><span class="o">)</span> <span class="o">||</span> <span class="n">mForceIdle</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 关闭屏幕，将变成inactive状态，开始等待最终是否会进入idle状态</span>
        <span class="c1">// mState为ACTIVE状态，mDeepEnabled从config文件读取config_enableAutoPowerModes字段，默认为false，GCM置为true.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">==</span> <span class="n">STATE_ACTIVE</span> <span class="o">&amp;&amp;</span> <span class="n">mDeepEnabled</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mState</span> <span class="o">=</span> <span class="n">STATE_INACTIVE</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved from STATE_ACTIVE to STATE_INACTIVE"</span><span class="o">);</span>
            <span class="n">resetIdleManagementLocked</span><span class="o">();</span>
            <span class="n">scheduleAlarmLocked</span><span class="o">(</span><span class="n">mInactiveTimeout</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdle</span><span class="o">(</span><span class="n">mState</span><span class="o">,</span> <span class="s">"no activity"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// mLightEnabled值同mDeepEnabled取值，mLightState为LIGHT_ACTIVE状态</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mLightState</span> <span class="o">==</span> <span class="n">LIGHT_STATE_ACTIVE</span> <span class="o">&amp;&amp;</span> <span class="n">mLightEnabled</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mLightState</span> <span class="o">=</span> <span class="n">LIGHT_STATE_INACTIVE</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved from LIGHT_STATE_ACTIVE to LIGHT_STATE_INACTIVE"</span><span class="o">);</span>
            <span class="n">resetLightIdleManagementLocked</span><span class="o">();</span>
            <span class="c1">// 默认5分钟</span>
            <span class="n">scheduleLightAlarmLocked</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_IDLE_AFTER_INACTIVE_TIMEOUT</span><span class="o">);</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleLight</span><span class="o">(</span><span class="n">mLightState</span><span class="o">,</span> <span class="s">"no activity"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>  关于config_enableAutoPowerModes字段，在GMS包中有做overlay处理，以便通过FCM推送：
<code class="highlighter-rouge">xml
    gms/products/gms_overlay/frameworks/base/core/res/res/values/config.xml
    &lt;bool name="config_enableAutoPowerModes"&gt;true&lt;/bool&gt;
</code></p>

<h4 id="resetlightidlemanagementlockedalarm">2.2 调用resetLightIdleManagementLocked方法重置之前设置过的轻度alarm等状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">resetLightIdleManagementLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 取消轻度Alarm唤醒</span>
        <span class="n">cancelLightAlarmLocked</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="schedulelightalarmlocked">2.3 调用scheduleLightAlarmLocked方法进行状态切换</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">scheduleLightAlarmLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">delay</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"scheduleLightAlarmLocked("</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="n">mNextLightAlarmTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">+</span> <span class="n">delay</span><span class="o">;</span>
        <span class="c1">// 设置LightAlarmListener监听器</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span>
            <span class="n">mNextLightAlarmTime</span><span class="o">,</span> <span class="s">"DeviceIdleController.light"</span><span class="o">,</span> <span class="n">mLightAlarmListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="lightalarmlistener">2.4 轻度休眠监听器LightAlarmListener</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AlarmManager</span><span class="o">.</span><span class="na">OnAlarmListener</span> <span class="n">mLightAlarmListener</span>
        <span class="o">=</span> <span class="k">new</span> <span class="n">AlarmManager</span><span class="o">.</span><span class="na">OnAlarmListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAlarm</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">DeviceIdleController</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 状态切换操作</span>
            <span class="n">stepLightIdleStateLocked</span><span class="o">(</span><span class="s">"s:alarm"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
</code></pre>
</div>

<h4 id="steplightidlestatelockedlightstateinactive---lightstatepreidle">2.5 调用stepLightIdleStateLocked处理状态切换(LIGHT_STATE_INACTIVE -&gt; LIGHT_STATE_PRE_IDLE)</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepLightIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 如果进入深度休眠，则不予处理轻度休眠操作。</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mLightState</span> <span class="o">==</span> <span class="n">LIGHT_STATE_OVERRIDE</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mLightState</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">LIGHT_STATE_INACTIVE:</span>
            <span class="c1">// LIGHT_IDLE_MAINTENANCE最小预估时间：1 * 60 * 1000（1分钟）</span>
            <span class="n">mCurIdleBudget</span> <span class="o">=</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_IDLE_MAINTENANCE_MIN_BUDGET</span><span class="o">;</span>
            <span class="c1">// 重置即将到来的空闲延迟时间：默认5 * 60 * 1000（5分钟）</span>
            <span class="n">mNextLightIdleDelay</span> <span class="o">=</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_IDLE_TIMEOUT</span><span class="o">;</span>
            <span class="n">mMaintenanceStartTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">isOpsInactiveLocked</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// 在首次idle状态之前要做一些处理.</span>
            <span class="n">mLightState</span> <span class="o">=</span> <span class="n">LIGHT_STATE_PRE_IDLE</span><span class="o">;</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleLight</span><span class="o">(</span><span class="n">mLightState</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
            <span class="c1">// LIGHT_PRE_IDLE默认时间：10 * 60 * 1000（10分钟）</span>
            <span class="n">scheduleLightAlarmLocked</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_PRE_IDLE_TIMEOUT</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code>    LIGHT_IDLE_MAINTENANCE_MIN_BUDGET = mParser.getLong( KEY_LIGHT_IDLE_MAINTENANCE_MIN_BUDGET, !COMPRESS_TIME ? 1 * 60 * 1000L : 15 * 1000L);
    LIGHT_IDLE_TIMEOUT = mParser.getLong(KEY_LIGHT_IDLE_TIMEOUT, !COMPRESS_TIME ? 5 * 60 * 1000L : 15 * 1000L);
    LIGHT_PRE_IDLE_TIMEOUT = mParser.getLong(KEY_LIGHT_PRE_IDLE_TIMEOUT, !COMPRESS_TIME ? 10 * 60 * 1000L : 30 * 1000L);
</code></pre>
</div>

<h4 id="steplightidlestatelockedlightstatepreidle---lightstateidle">2.6 调用stepLightIdleStateLocked处理状态切换(LIGHT_STATE_PRE_IDLE -&gt; LIGHT_STATE_IDLE)</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepLightIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mLightState</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">LIGHT_STATE_PRE_IDLE:</span>
            <span class="c1">// mMaintenanceStartTime为空不进入</span>
            <span class="o">.....</span>
            <span class="n">mMaintenanceStartTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="c1">// 5 * 60 * 1000 * (2 ^ n) </span>
            <span class="n">scheduleLightAlarmLocked</span><span class="o">(</span><span class="n">mNextLightIdleDelay</span><span class="o">);</span>
            <span class="c1">// min(15 * 60 * 1000, 5 * 60 * 1000 * (2 ^ n) )</span>
            <span class="n">mNextLightIdleDelay</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_MAX_IDLE_TIMEOUT</span><span class="o">,</span>
                <span class="o">(</span><span class="kt">long</span><span class="o">)(</span><span class="n">mNextLightIdleDelay</span> <span class="o">*</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_IDLE_FACTOR</span><span class="o">));</span>
            <span class="c1">// 确保mNextLightIdleDelay始终大于默认值</span>
            <span class="o">......</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved to LIGHT_STATE_IDLE."</span><span class="o">);</span>
            <span class="n">mLightState</span> <span class="o">=</span> <span class="n">LIGHT_STATE_IDLE</span><span class="o">;</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleLight</span><span class="o">(</span><span class="n">mLightState</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
            <span class="n">addEvent</span><span class="o">(</span><span class="n">EVENT_LIGHT_IDLE</span><span class="o">);</span>
            <span class="c1">// 持有PARTIAL_WAKE_LOCK锁（Cpu唤醒，屏幕/键盘关）</span>
            <span class="n">mGoingIdleWakeLock</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
            <span class="c1">// 发送MSG_REPORT_IDLE_ON_LIGHT，准备进入轻度IDLE模式</span>
            <span class="n">mHandler</span><span class="o">.</span><span class="na">sendEmptyMessage</span><span class="o">(</span><span class="n">MSG_REPORT_IDLE_ON_LIGHT</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="msgreportidleonlightlightidle">2.7 发送MSG_REPORT_IDLE_ON_LIGHT消息，准备进入LIGHT_IDLE模式</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"handleMessage("</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">MSG_REPORT_IDLE_ON_LIGHT:</span> <span class="o">{</span>
            <span class="c1">// 持有mGoingIdleWakeLock</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleOnStart</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">deepChanged</span><span class="o">;</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">lightChanged</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">==</span> <span class="n">MSG_REPORT_IDLE_ON</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">deepChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setDeviceIdleMode</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">lightChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setLightDeviceIdleMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="c1">// 打开轻度休眠，关闭深度休眠</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">deepChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setDeviceIdleMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">lightChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setLightDeviceIdleMode</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 网络服务处于休眠模式</span>
            <span class="n">mNetworkPolicyManager</span><span class="o">.</span><span class="na">setDeviceIdleMode</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="c1">// 电池统计服务处于轻度休眠模式</span>
            <span class="n">mBatteryStats</span><span class="o">.</span><span class="na">noteDeviceIdleMode</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">==</span> <span class="n">MSG_REPORT_IDLE_ON</span>
                <span class="o">?</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">DEVICE_IDLE_MODE_DEEP</span>
                <span class="o">:</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">DEVICE_IDLE_MODE_LIGHT</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">myUid</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">deepChanged</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">getContext</span><span class="o">().</span><span class="na">sendBroadcastAsUser</span><span class="o">(</span><span class="n">mIdleIntent</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">ALL</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lightChanged</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">getContext</span><span class="o">().</span><span class="na">sendBroadcastAsUser</span><span class="o">(</span><span class="n">mLightIdleIntent</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">ALL</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleOnComplete</span><span class="o">();</span>
            <span class="c1">// 释放mGoingIdleWakeLock</span>
            <span class="n">mGoingIdleWakeLock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">break</span><span class="o">;</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="steplightidlestatelockedlightstatepreidle---lightstatewaitingfornetwork">2.8 调用stepLightIdleStateLocked处理状态切换(LIGHT_STATE_PRE_IDLE -&gt; LIGHT_STATE_WAITING_FOR_NETWORK)</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepLightIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mLightState</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">LIGHT_STATE_PRE_IDLE:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mNetworkConnected</span> <span class="o">||</span> <span class="n">mLightState</span> <span class="o">==</span> <span class="n">LIGHT_STATE_WAITING_FOR_NETWORK</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">......</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// We'd like to do maintenance, but currently don't have network</span>
            <span class="c1">//　想继续保持，但是没有网络，尝试等待直至网络重连，直到超过一个idle周期放弃。</span>
            <span class="c1">// min(15 * 60 * 1000, 5 * 60 * 1000 * (2 ^ n) )</span>
            <span class="n">scheduleLightAlarmLocked</span><span class="o">(</span><span class="n">mNextLightIdleDelay</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved to LIGHT_WAITING_FOR_NETWORK."</span><span class="o">);</span>
            <span class="n">mLightState</span> <span class="o">=</span> <span class="n">LIGHT_STATE_WAITING_FOR_NETWORK</span><span class="o">;</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleLight</span><span class="o">(</span><span class="n">mLightState</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="steplightidlestatelockedlightstatewaitingfornetwork---lightstateidlemaintenance">2.9 调用stepLightIdleStateLocked处理状态切换(LIGHT_STATE_WAITING_FOR_NETWORK -&gt; LIGHT_STATE_IDLE_MAINTENANCE)</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepLightIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mLightState</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">LIGHT_STATE_WAITING_FOR_NETWORK:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mNetworkConnected</span> <span class="o">||</span> <span class="n">mLightState</span> <span class="o">==</span> <span class="n">LIGHT_STATE_WAITING_FOR_NETWORK</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mActiveIdleOpCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
            <span class="n">mActiveIdleWakeLock</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
            <span class="n">mMaintenanceStartTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
            <span class="c1">// Maintenance状态最小预估时间１分钟，最长预估时间５分钟</span>
            <span class="o">......</span>
            <span class="c1">// 取值1 - 5分钟</span>
            <span class="n">scheduleLightAlarmLocked</span><span class="o">(</span><span class="n">mCurIdleBudget</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span>
                <span class="s">"Moved from LIGHT_STATE_IDLE to LIGHT_STATE_IDLE_MAINTENANCE."</span><span class="o">);</span>
            <span class="n">mLightState</span> <span class="o">=</span> <span class="n">LIGHT_STATE_IDLE_MAINTENANCE</span><span class="o">;</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleLight</span><span class="o">(</span><span class="n">mLightState</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
            <span class="n">addEvent</span><span class="o">(</span><span class="n">EVENT_LIGHT_MAINTENANCE</span><span class="o">);</span>
            <span class="c1">// 发送MSG_REPORT_IDLE_OFF消息，退出深度IDLE模式</span>
            <span class="n">mHandler</span><span class="o">.</span><span class="na">sendEmptyMessage</span><span class="o">(</span><span class="n">MSG_REPORT_IDLE_OFF</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="o">......</span>
            <span class="o">}</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="msgreportidleofflightidle">2.10 发送MSG_REPORT_IDLE_OFF消息，准备退出LIGHT_IDLE模式</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"handleMessage("</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">MSG_REPORT_IDLE_OFF:</span> <span class="o">{</span>
            <span class="c1">// 持有mActiveIdleWakeLock</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleOffStart</span><span class="o">(</span><span class="s">"unknown"</span><span class="o">);</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">deepChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setDeviceIdleMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">lightChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setLightDeviceIdleMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
            <span class="n">mNetworkPolicyManager</span><span class="o">.</span><span class="na">setDeviceIdleMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">mBatteryStats</span><span class="o">.</span><span class="na">noteDeviceIdleMode</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">DEVICE_IDLE_MODE_OFF</span><span class="o">,</span>
                <span class="kc">null</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">myUid</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">deepChanged</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">incActiveIdleOps</span><span class="o">();</span>
            <span class="n">getContext</span><span class="o">().</span><span class="na">sendOrderedBroadcastAsUser</span><span class="o">(</span><span class="n">mIdleIntent</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>
                <span class="kc">null</span><span class="o">,</span> <span class="n">mIdleStartedDoneReceiver</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lightChanged</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">incActiveIdleOps</span><span class="o">();</span>
            <span class="n">getContext</span><span class="o">().</span><span class="na">sendOrderedBroadcastAsUser</span><span class="o">(</span><span class="n">mLightIdleIntent</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>
                <span class="kc">null</span><span class="o">,</span> <span class="n">mIdleStartedDoneReceiver</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">decActiveIdleOps</span><span class="o">();</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleOffComplete</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">break</span><span class="o">;</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="decactiveidleopsmaintenance">2.11 调用decActiveIdleOps方法退出Maintenance状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">decActiveIdleOps</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mActiveIdleOpCount</span><span class="o">--;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mActiveIdleOpCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">exitMaintenanceEarlyIfNeededLocked</span><span class="o">();</span>
            <span class="n">mActiveIdleWakeLock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="exitmaintenanceearlyifneededlockedmaintenance">2.12 调用exitMaintenanceEarlyIfNeededLocked方法处理退出Maintenance一系列操作</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">exitMaintenanceEarlyIfNeededLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">==</span> <span class="n">STATE_IDLE_MAINTENANCE</span> <span class="o">||</span> <span class="n">mLightState</span> <span class="o">==</span> <span class="n">LIGHT_STATE_IDLE_MAINTENANCE</span>
            <span class="o">||</span> <span class="n">mLightState</span> <span class="o">==</span> <span class="n">LIGHT_STATE_PRE_IDLE</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isOpsInactiveLocked</span><span class="o">())</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"Exit: start="</span><span class="o">);</span>
            <span class="n">TimeUtils</span><span class="o">.</span><span class="na">formatDuration</span><span class="o">(</span><span class="n">mMaintenanceStartTime</span><span class="o">,</span> <span class="n">sb</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" now="</span><span class="o">);</span>
            <span class="n">TimeUtils</span><span class="o">.</span><span class="na">formatDuration</span><span class="o">(</span><span class="n">now</span><span class="o">,</span> <span class="n">sb</span><span class="o">);</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">==</span> <span class="n">STATE_IDLE_MAINTENANCE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stepIdleStateLocked</span><span class="o">(</span><span class="s">"s:early"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mLightState</span> <span class="o">==</span> <span class="n">LIGHT_STATE_PRE_IDLE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stepLightIdleStateLocked</span><span class="o">(</span><span class="s">"s:predone"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">stepLightIdleStateLocked</span><span class="o">(</span><span class="s">"s:early"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="steplightidlestatelockedlightstateidlemaintenance---lightstateidle">2.13 调用stepLightIdleStateLocked处理状态切换(LIGHT_STATE_IDLE_MAINTENANCE -&gt; LIGHT_STATE_IDLE)</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepLightIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mLightState</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">LIGHT_STATE_IDLE_MAINTENANCE:</span>
            <span class="c1">// mMaintenanceStartTime不为空时调整最小预估时间</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mMaintenanceStartTime</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">-</span> <span class="n">mMaintenanceStartTime</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">duration</span> <span class="o">&lt;</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_IDLE_MAINTENANCE_MIN_BUDGET</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mCurIdleBudget</span> <span class="o">+=</span> <span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_IDLE_MAINTENANCE_MIN_BUDGET</span><span class="o">-</span><span class="n">duration</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">mCurIdleBudget</span> <span class="o">-=</span> <span class="o">(</span><span class="n">duration</span><span class="o">-</span><span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_IDLE_MAINTENANCE_MIN_BUDGET</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">mMaintenanceStartTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="c1">// 5 * 60 * 1000 * (2 ^ n) </span>
            <span class="n">scheduleLightAlarmLocked</span><span class="o">(</span><span class="n">mNextLightIdleDelay</span><span class="o">);</span>
            <span class="c1">// min(15 * 60 * 1000, 5 * 60 * 1000 * (2 ^ n) )</span>
            <span class="n">mNextLightIdleDelay</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_MAX_IDLE_TIMEOUT</span><span class="o">,</span>
                <span class="o">(</span><span class="kt">long</span><span class="o">)(</span><span class="n">mNextLightIdleDelay</span> <span class="o">*</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_IDLE_FACTOR</span><span class="o">));</span>
            <span class="c1">// 确保mNextLightIdleDelay始终大于默认值</span>
            <span class="o">......</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved to LIGHT_STATE_IDLE."</span><span class="o">);</span>
            <span class="n">mLightState</span> <span class="o">=</span> <span class="n">LIGHT_STATE_IDLE</span><span class="o">;</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleLight</span><span class="o">(</span><span class="n">mLightState</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
            <span class="n">addEvent</span><span class="o">(</span><span class="n">EVENT_LIGHT_IDLE</span><span class="o">);</span>
            <span class="c1">// 持有PARTIAL_WAKE_LOCK锁（Cpu唤醒，屏幕/键盘关）</span>
            <span class="n">mGoingIdleWakeLock</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
            <span class="c1">// 发送MSG_REPORT_IDLE_ON_LIGHT，准备进入轻度IDLE模式</span>
            <span class="n">mHandler</span><span class="o">.</span><span class="na">sendEmptyMessage</span><span class="o">(</span><span class="n">MSG_REPORT_IDLE_ON_LIGHT</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>
