<h3 id="active---inactive---idlepending">一、ACTIVE -&gt; INACTIVE -&gt; IDLE_PENDING状态切换</h3>

<p>状态机：
<img src="https://xiezeyangcn.github.io/xzyblog.github.io/assets/images/2017-11-26-deep-doze-mode/doze_state_n_deep.bmp" alt="" /></p>

<p>时序图：</p>

<p><img src="https://xiezeyangcn.github.io/xzyblog.github.io/assets/images/2017-11-26-deep-doze-mode/active_inactive_idlepending.bmp" alt="" /></p>

<h4 id="actionbatterychanged">1.1 注册接收电池状态变化广播ACTION_BATTERY_CHANGED</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BroadcastReceiver</span> <span class="n">mReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BroadcastReceiver</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_BATTERY_CHANGED</span><span class="o">:</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">DeviceIdleController</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">plugged</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getIntExtra</span><span class="o">(</span><span class="s">"plugged"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="n">updateChargingLocked</span><span class="o">(</span><span class="n">plugged</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">break</span><span class="o">;</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">};</span>
</code></pre>
</div>

<h4 id="updatecharginglocked">1.2 调用updateChargingLocked方法更新充电状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">updateChargingLocked</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">charging</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"updateChargingLocked: charging="</span> <span class="o">+</span> <span class="n">charging</span><span class="o">);</span>
        <span class="c1">// 从充电-&gt;不充电状态</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">charging</span> <span class="o">&amp;&amp;</span> <span class="n">mCharging</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 将当前充电状态置为false</span>
        <span class="n">mCharging</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="c1">// 用于dumpsys调试时强制写入的状态</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mForceIdle</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">becomeInactiveIfAppropriateLocked</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">charging</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mCharging</span> <span class="o">=</span> <span class="n">charging</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mForceIdle</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">becomeActiveLocked</span><span class="o">(</span><span class="s">"charging"</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">myUid</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="becomeinactiveifappropriatelockedinactive">1.3 调用becomeInactiveIfAppropriateLocked方法判断是否允许设备进入INACTIVE状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">becomeInactiveIfAppropriateLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 灭屏&amp;未充电，或强制空闲</span>
        <span class="k">if</span> <span class="o">((!</span><span class="n">mScreenOn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mCharging</span><span class="o">)</span> <span class="o">||</span> <span class="n">mForceIdle</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 关闭屏幕，将变成inactive状态，开始等待最终是否会进入idle状态</span>
        <span class="c1">// mState为ACTIVE状态，mDeepEnabled从config文件读取config_enableAutoPowerModes字段，默认为false</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">==</span> <span class="n">STATE_ACTIVE</span> <span class="o">&amp;&amp;</span> <span class="n">mDeepEnabled</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mState</span> <span class="o">=</span> <span class="n">STATE_INACTIVE</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved from STATE_ACTIVE to STATE_INACTIVE"</span><span class="o">);</span>
            <span class="n">resetIdleManagementLocked</span><span class="o">();</span>
            <span class="n">scheduleAlarmLocked</span><span class="o">(</span><span class="n">mInactiveTimeout</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdle</span><span class="o">(</span><span class="n">mState</span><span class="o">,</span> <span class="s">"no activity"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mLightState</span> <span class="o">==</span> <span class="n">LIGHT_STATE_ACTIVE</span> <span class="o">&amp;&amp;</span> <span class="n">mLightEnabled</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mLightState</span> <span class="o">=</span> <span class="n">LIGHT_STATE_INACTIVE</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved from LIGHT_STATE_ACTIVE to LIGHT_STATE_INACTIVE"</span><span class="o">);</span>
            <span class="n">resetLightIdleManagementLocked</span><span class="o">();</span>
            <span class="n">scheduleLightAlarmLocked</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">LIGHT_IDLE_AFTER_INACTIVE_TIMEOUT</span><span class="o">);</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleLight</span><span class="o">(</span><span class="n">mLightState</span><span class="o">,</span> <span class="s">"no activity"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>  关于config_enableAutoPowerModes字段，在GMS包中有做overlay处理，以便通过FCM推送：</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code>    gms/products/gms_overlay/frameworks/base/core/res/res/values/config.xml
    <span class="nt">&lt;bool</span> <span class="na">name=</span><span class="s">"config_enableAutoPowerModes"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/bool&gt;</span>
</code></pre>
</div>

<h4 id="displaylistener">1.4 屏幕状态变化监听器DisplayListener</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DisplayManager</span><span class="o">.</span><span class="na">DisplayListener</span> <span class="n">mDisplayListener</span>
        <span class="o">=</span> <span class="k">new</span> <span class="n">DisplayManager</span><span class="o">.</span><span class="na">DisplayListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDisplayAdded</span><span class="o">(</span><span class="kt">int</span> <span class="n">displayId</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDisplayRemoved</span><span class="o">(</span><span class="kt">int</span> <span class="n">displayId</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDisplayChanged</span><span class="o">(</span><span class="kt">int</span> <span class="n">displayId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">displayId</span> <span class="o">==</span> <span class="n">Display</span><span class="o">.</span><span class="na">DEFAULT_DISPLAY</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">DeviceIdleController</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">updateDisplayLocked</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
</code></pre>
</div>

<h4 id="updatedisplaylocked">1.5 调用updateDisplayLocked方法更新显示器状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">updateDisplayLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">mCurDisplay</span> <span class="o">=</span> <span class="n">mDisplayManager</span><span class="o">.</span><span class="na">getDisplay</span><span class="o">(</span><span class="n">Display</span><span class="o">.</span><span class="na">DEFAULT_DISPLAY</span><span class="o">);</span>
        <span class="c1">// 考虑到显示器显示某些东西的情况，因为如果显示任何东西都需频繁去更新，所以不允许进入深度休眠</span>
        <span class="kt">boolean</span> <span class="n">screenOn</span> <span class="o">=</span> <span class="n">mCurDisplay</span><span class="o">.</span><span class="na">getState</span><span class="o">()</span> <span class="o">==</span> <span class="n">Display</span><span class="o">.</span><span class="na">STATE_ON</span><span class="o">;</span>
        <span class="c1">// 亮屏-&gt;灭屏</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">screenOn</span> <span class="o">&amp;&amp;</span> <span class="n">mScreenOn</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mScreenOn</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mForceIdle</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">becomeInactiveIfAppropriateLocked</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">screenOn</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mScreenOn</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mForceIdle</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">becomeActiveLocked</span><span class="o">(</span><span class="s">"screen"</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">myUid</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="resetidlemanagementlockedalarm">1.6 调用resetIdleManagementLocked方法重置之前设置过的alarm等状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">resetIdleManagementLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">mNextIdlePendingDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">mNextIdleDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">mNextLightIdleDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">cancelAlarmLocked</span><span class="o">();</span>
        <span class="n">cancelSensingTimeoutAlarmLocked</span><span class="o">();</span>
        <span class="n">cancelLocatingLocked</span><span class="o">();</span>
        <span class="n">stopMonitoringMotionLocked</span><span class="o">();</span>
        <span class="n">mAnyMotionDetector</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="schedulealarmlocked">1.7 调用scheduleAlarmLocked方法进行状态切换</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">scheduleAlarmLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">delay</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">idleUntil</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mMotionSensor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 如果设备没有运动传感器，则不安排时钟，因为无法确定设备是否移动</span>
        <span class="c1">// 这有效关闭了设备空闲的正常执行，尽管仍然可能假装像关闭闹钟一样去拨动它</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mNextAlarmTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">+</span> <span class="n">delay</span><span class="o">;</span>
        <span class="c1">// 设置AlarmListener监听器，调用stepIdleStateLocked方法做状态切换</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">idleUntil</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">setIdleUntil</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span>
            <span class="n">mNextAlarmTime</span><span class="o">,</span> <span class="s">"DeviceIdleController.deep"</span><span class="o">,</span> <span class="n">mDeepAlarmListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span>
            <span class="n">mNextAlarmTime</span><span class="o">,</span> <span class="s">"DeviceIdleController.deep"</span><span class="o">,</span> <span class="n">mDeepAlarmListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="section">1.8 深度休眠监听器</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AlarmManager</span><span class="o">.</span><span class="na">OnAlarmListener</span> <span class="n">mDeepAlarmListener</span>
        <span class="o">=</span> <span class="k">new</span> <span class="n">AlarmManager</span><span class="o">.</span><span class="na">OnAlarmListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAlarm</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">DeviceIdleController</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stepIdleStateLocked</span><span class="o">(</span><span class="s">"s:alarm"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
</code></pre>
</div>

<h4 id="stepidlestatelockedstateinactive-stateidlepending">1.9 调用stepIdleStateLocked处理STATE_INACTIVE-&gt;STATE_IDLE_PENDING状态切换</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mState</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">STATE_INACTIVE:</span>
            <span class="c1">// 现在不活跃，开始寻找更多休眠、运动信息</span>
            <span class="n">startMonitoringMotionLocked</span><span class="o">();</span>
            <span class="c1">// 30 * 60 * 1000L: 30分钟</span>
            <span class="n">scheduleAlarmLocked</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">IDLE_AFTER_INACTIVE_TIMEOUT</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="c1">// 重置即将到来的空闲</span>
            <span class="c1">// 5 * 60 * 1000L: 5分钟</span>
            <span class="n">mNextIdlePendingDelay</span> <span class="o">=</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">IDLE_PENDING_TIMEOUT</span><span class="o">;</span>
            <span class="c1">// 60 * 60 * 1000L: 60分钟</span>
            <span class="n">mNextIdleDelay</span> <span class="o">=</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">IDLE_TIMEOUT</span><span class="o">;</span>
            <span class="n">mState</span> <span class="o">=</span> <span class="n">STATE_IDLE_PENDING</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved from STATE_INACTIVE to STATE_IDLE_PENDING."</span><span class="o">);</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdle</span><span class="o">(</span><span class="n">mState</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">......</span>
    <span class="o">}</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>    long idleAfterInactiveTimeout = (mHasWatch ? 15 : 30) * 60 * 1000L;
    IDLE_AFTER_INACTIVE_TIMEOUT = mParser.getLong(KEY_IDLE_AFTER_INACTIVE_TIMEOUT,!COMPRESS_TIME ? idleAfterInactiveTimeout : (idleAfterInactiveTimeout / 10));

    IDLE_PENDING_TIMEOUT = mParser.getLong(KEY_IDLE_PENDING_TIMEOUT, !COMPRESS_TIME ? 5 * 60 * 1000L : 30 * 1000L);

    IDLE_TIMEOUT = mParser.getLong(KEY_IDLE_TIMEOUT, !COMPRESS_TIME ? 60 * 60 * 1000L : 6 * 60 * 1000L);
</code></pre>
</div>

<h4 id="startmonitoringmotionlockedmotion">1.10 调用startMonitoringMotionLocked方法注册motion传感器获取运动信息</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">startMonitoringMotionLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"startMonitoringMotionLocked()"</span><span class="o">);</span>
        <span class="c1">// 注册sensor监听器</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mMotionSensor</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mMotionListener</span><span class="o">.</span><span class="na">active</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mMotionListener</span><span class="o">.</span><span class="na">registerLocked</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">registerLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">success</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mMotionSensor</span><span class="o">.</span><span class="na">getReportingMode</span><span class="o">()</span> <span class="o">==</span> <span class="n">Sensor</span><span class="o">.</span><span class="na">REPORTING_MODE_ONE_SHOT</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">mSensorManager</span><span class="o">.</span><span class="na">requestTriggerSensor</span><span class="o">(</span><span class="n">mMotionListener</span><span class="o">,</span> <span class="n">mMotionSensor</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">mSensorManager</span><span class="o">.</span><span class="na">registerListener</span><span class="o">(</span>
            <span class="n">mMotionListener</span><span class="o">,</span> <span class="n">mMotionSensor</span><span class="o">,</span> <span class="n">SensorManager</span><span class="o">.</span><span class="na">SENSOR_DELAY_NORMAL</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">success</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">active</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Unable to register for "</span> <span class="o">+</span> <span class="n">mMotionSensor</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">success</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="schedulealarmlocked-1">1.11 调用scheduleAlarmLocked方法进行状态切换</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">scheduleAlarmLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">delay</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">idleUntil</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"scheduleAlarmLocked("</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">idleUntil</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mMotionSensor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 如果设备没有运动传感器，则不安排时钟，因为无法确定设备是否移动</span>
        <span class="c1">// 这有效关闭了设备空闲的正常执行，尽管仍然可能假装像关闭闹钟一样去拨动它</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mNextAlarmTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">+</span> <span class="n">delay</span><span class="o">;</span>
        <span class="c1">// 设置AlarmListener监听器，调用stepIdleStateLocked方法做状态切换</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">idleUntil</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">setIdleUntil</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span>
            <span class="n">mNextAlarmTime</span><span class="o">,</span> <span class="s">"DeviceIdleController.deep"</span><span class="o">,</span> <span class="n">mDeepAlarmListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span>
            <span class="n">mNextAlarmTime</span><span class="o">,</span> <span class="s">"DeviceIdleController.deep"</span><span class="o">,</span> <span class="n">mDeepAlarmListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="idlepending---sensing---locating">二、IDLE_PENDING -&gt; SENSING -&gt; LOCATING状态切换</h3>

<p>时序图：</p>

<p><img src="https://xiezeyangcn.github.io/xzyblog.github.io/assets/images/2017-11-26-deep-doze-mode/idlepending_sensing.bmp" alt="" /></p>

<p><img src="https://xiezeyangcn.github.io/xzyblog.github.io/assets/images/2017-11-26-deep-doze-mode/sensing_locating.bmp" alt="" /></p>

<h4 id="stepidlestatelocked">2.1 stepIdleStateLocked</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mState</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">STATE_IDLE_PENDING:</span>
            <span class="n">mState</span> <span class="o">=</span> <span class="n">STATE_SENSING</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved from STATE_IDLE_PENDING to STATE_SENSING."</span><span class="o">);</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdle</span><span class="o">(</span><span class="n">mState</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
            <span class="c1">// 4 * 60 * 1000L: 4分钟</span>
            <span class="n">scheduleSensingTimeoutAlarmLocked</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">SENSING_TIMEOUT</span><span class="o">);</span>
            <span class="n">cancelLocatingLocked</span><span class="o">();</span>
            <span class="n">mNotMoving</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">mLocated</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">mLastGenericLocation</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">mLastGpsLocation</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">mAnyMotionDetector</span><span class="o">.</span><span class="na">checkForAnyMotion</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="err">####</span> <span class="mf">2.2</span> <span class="n">scheduleSensingTimeoutAlarmLocked</span><span class="err">方法设置</span><span class="n">Alarm</span><span class="err">监听器</span>

<span class="err">```</span><span class="n">java</span>
    <span class="kt">void</span> <span class="nf">scheduleSensingTimeoutAlarmLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">delay</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"scheduleSensingAlarmLocked("</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="n">mNextSensingTimeoutAlarmTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">+</span> <span class="n">delay</span><span class="o">;</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span> <span class="n">mNextSensingTimeoutAlarmTime</span><span class="o">,</span>
        <span class="s">"DeviceIdleController.sensing"</span><span class="o">,</span> <span class="n">mSensingTimeoutAlarmListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="cancellocatinglocked">2.3 cancelLocatingLocked方法取消位置监听</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">cancelLocatingLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mLocating</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// STATE_SENSING下注册mGenericLocationListener、mGpsLocationListener监听器</span>
        <span class="n">mLocationManager</span><span class="o">.</span><span class="na">removeUpdates</span><span class="o">(</span><span class="n">mGenericLocationListener</span><span class="o">);</span>
        <span class="n">mLocationManager</span><span class="o">.</span><span class="na">removeUpdates</span><span class="o">(</span><span class="n">mGpsLocationListener</span><span class="o">);</span>
        <span class="n">mLocating</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="checkforanymotionanymotion">2.4 checkForAnyMotion方法确定anymotion状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkForAnyMotion</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">!=</span> <span class="n">STATE_ACTIVE</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mState</span> <span class="o">=</span> <span class="n">STATE_ACTIVE</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved from STATE_INACTIVE to STATE_ACTIVE."</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">mCurrentGravityVector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">mPreviousGravityVector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">mWakeLock</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
            <span class="n">Message</span> <span class="n">wakelockTimeoutMsg</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">mHandler</span><span class="o">,</span> <span class="n">mWakelockTimeout</span><span class="o">);</span>
            <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageDelayed</span><span class="o">(</span><span class="n">wakelockTimeoutMsg</span><span class="o">,</span> <span class="n">WAKELOCK_TIMEOUT_MILLIS</span><span class="o">);</span>
            <span class="n">mWakelockTimeoutIsActive</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">startOrientationMeasurementLocked</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="startorientationmeasurementlocked">2.5 startOrientationMeasurementLocked进行行为检测</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">startOrientationMeasurementLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"startOrientationMeasurementLocked: mMeasurementInProgress="</span> <span class="o">+</span>
        <span class="n">mMeasurementInProgress</span> <span class="o">+</span> <span class="s">", (mAccelSensor != null)="</span> <span class="o">+</span> <span class="o">(</span><span class="n">mAccelSensor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mMeasurementInProgress</span> <span class="o">&amp;&amp;</span> <span class="n">mAccelSensor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 注册加速度传感器</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mSensorManager</span><span class="o">.</span><span class="na">registerListener</span><span class="o">(</span><span class="n">mListener</span><span class="o">,</span> <span class="n">mAccelSensor</span><span class="o">,</span>
            <span class="n">SAMPLING_INTERVAL_MILLIS</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">mMeasurementInProgress</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">mRunningStats</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">Message</span> <span class="n">measurementTimeoutMsg</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">mHandler</span><span class="o">,</span> <span class="n">mMeasurementTimeout</span><span class="o">);</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageDelayed</span><span class="o">(</span><span class="n">measurementTimeoutMsg</span><span class="o">,</span> <span class="n">ACCELEROMETER_DATA_TIMEOUT_MILLIS</span><span class="o">);</span>
        <span class="n">mMeasurementTimeoutIsActive</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="mmeasurementtimeoutanymotiondeviceidlecontrroller">2.6 mMeasurementTimeout回调返回anymotion结果至DeviceIdleContrroller</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">mMeasurementTimeout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">RESULT_UNKNOWN</span><span class="o">;</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mMeasurementTimeoutIsActive</span> <span class="o">==</span> <span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mMeasurementTimeoutIsActive</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"mMeasurementTimeout. Failed to collect sufficient accel "</span> <span class="o">+</span>
                  <span class="s">"data within "</span> <span class="o">+</span> <span class="n">ACCELEROMETER_DATA_TIMEOUT_MILLIS</span> <span class="o">+</span> <span class="s">" ms. Stopping "</span> <span class="o">+</span>
                  <span class="s">"orientation measurement."</span><span class="o">);</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">stopOrientationMeasurementLocked</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">RESULT_UNKNOWN</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mHandler</span><span class="o">.</span><span class="na">removeCallbacks</span><span class="o">(</span><span class="n">mWakelockTimeout</span><span class="o">);</span>
                <span class="n">mWakelockTimeoutIsActive</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="n">mCallback</span><span class="o">.</span><span class="na">onAnyMotionResult</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
</code></pre>
</div>

<h4 id="onanymotionresult">2.7 onAnyMotionResult方法</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnyMotionResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"onAnyMotionResult("</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">AnyMotionDetector</span><span class="o">.</span><span class="na">RESULT_UNKNOWN</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">cancelSensingTimeoutAlarmLocked</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">result</span> <span class="o">==</span> <span class="n">AnyMotionDetector</span><span class="o">.</span><span class="na">RESULT_MOVED</span><span class="o">)</span> <span class="o">||</span>
        <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">AnyMotionDetector</span><span class="o">.</span><span class="na">RESULT_UNKNOWN</span><span class="o">))</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handleMotionDetectedLocked</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">INACTIVE_TIMEOUT</span><span class="o">,</span> <span class="s">"non_stationary"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">AnyMotionDetector</span><span class="o">.</span><span class="na">RESULT_STATIONARY</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">==</span> <span class="n">STATE_SENSING</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 如果当前处于SENSING状态，则调用stepIdleStateLocked切换至LOCATING状态</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mNotMoving</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">stepIdleStateLocked</span><span class="o">(</span><span class="s">"s:stationary"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="stepidlestatelocked-1">2.8 stepIdleStateLocked</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mState</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">STATE_SENSING:</span>
            <span class="n">cancelSensingTimeoutAlarmLocked</span><span class="o">();</span>
            <span class="n">mState</span> <span class="o">=</span> <span class="n">STATE_LOCATING</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved from STATE_SENSING to STATE_LOCATING."</span><span class="o">);</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdle</span><span class="o">(</span><span class="n">mState</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
            <span class="c1">// 30 * 1000L: 30s</span>
            <span class="n">scheduleAlarmLocked</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">LOCATING_TIMEOUT</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mLocationManager</span> <span class="o">!=</span> <span class="kc">null</span>
                <span class="o">&amp;&amp;</span> <span class="n">mLocationManager</span><span class="o">.</span><span class="na">getProvider</span><span class="o">(</span><span class="n">LocationManager</span><span class="o">.</span><span class="na">NETWORK_PROVIDER</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 精度为ACCURACY_FINE的定位服务</span>
            <span class="n">mLocationManager</span><span class="o">.</span><span class="na">requestLocationUpdates</span><span class="o">(</span><span class="n">mLocationRequest</span><span class="o">,</span>
                <span class="n">mGenericLocationListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">getLooper</span><span class="o">());</span>
            <span class="n">mLocating</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">mHasNetworkLocation</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mLocationManager</span> <span class="o">!=</span> <span class="kc">null</span>
                <span class="o">&amp;&amp;</span> <span class="n">mLocationManager</span><span class="o">.</span><span class="na">getProvider</span><span class="o">(</span><span class="n">LocationManager</span><span class="o">.</span><span class="na">GPS_PROVIDER</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mHasGps</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">mLocationManager</span><span class="o">.</span><span class="na">requestLocationUpdates</span><span class="o">(</span><span class="n">LocationManager</span><span class="o">.</span><span class="na">GPS_PROVIDER</span><span class="o">,</span> <span class="mi">1000</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span>
                <span class="n">mGpsLocationListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">.</span><span class="na">getLooper</span><span class="o">());</span>
            <span class="n">mLocating</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">mHasGps</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mLocating</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="cancelsensingtimeoutalarmlockedalarm">2.9 cancelSensingTimeoutAlarmLocked方法取消Alarm监听</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">cancelSensingTimeoutAlarmLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mNextSensingTimeoutAlarmTime</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mNextSensingTimeoutAlarmTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="n">mSensingTimeoutAlarmListener</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="schedulealarmlockedmotion-sensordeepalarm">2.10 scheduleAlarmLocked方法在有motion sensor的前提下设置DeepAlarm监听器</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">scheduleAlarmLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">delay</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">idleUntil</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"scheduleAlarmLocked("</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">idleUntil</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mMotionSensor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 如果设备没有运动传感器，则不安排时钟，因为无法确定设备是否移动</span>
        <span class="c1">// 这有效关闭了设备空闲的正常执行，尽管仍然可能假装像关闭闹钟一样去拨动它</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mNextAlarmTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">+</span> <span class="n">delay</span><span class="o">;</span>
        <span class="c1">// 设置AlarmListener监听器，调用stepIdleStateLocked方法做状态切换</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">idleUntil</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">setIdleUntil</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span>
            <span class="n">mNextAlarmTime</span><span class="o">,</span> <span class="s">"DeviceIdleController.deep"</span><span class="o">,</span> <span class="n">mDeepAlarmListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span>
            <span class="n">mNextAlarmTime</span><span class="o">,</span> <span class="s">"DeviceIdleController.deep"</span><span class="o">,</span> <span class="n">mDeepAlarmListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="err">```</span><span class="n">java</span>


<span class="err">####</span> <span class="mf">2.11</span> <span class="n">mGenericLocationListener</span><span class="err">位置监听器</span>

<span class="err">```</span><span class="n">java</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">LocationListener</span> <span class="n">mGenericLocationListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocationListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLocationChanged</span><span class="o">(</span><span class="n">Location</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">DeviceIdleController</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">receivedGenericLocationLocked</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">......</span>
    <span class="o">};</span>
</code></pre>
</div>

<h4 id="receivedgenericlocationlockedlocationaccuracy">2.12 receivedGenericLocationLocked方法监听L精度为OCATION_ACCURACY的定位服务</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">receivedGenericLocationLocked</span><span class="o">(</span><span class="n">Location</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">!=</span> <span class="n">STATE_LOCATING</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">cancelLocatingLocked</span><span class="o">();</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Generic location: "</span> <span class="o">+</span> <span class="n">location</span><span class="o">);</span>
        <span class="n">mLastGenericLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Location</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">getAccuracy</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">LOCATION_ACCURACY</span> <span class="o">&amp;&amp;</span> <span class="n">mHasGps</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mLocated</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mNotMoving</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">stepIdleStateLocked</span><span class="o">(</span><span class="s">"s:location"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="mgpslocationlistenergps">2.13 mGpsLocationListener方法GPS位置监听</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">LocationListener</span> <span class="n">mGpsLocationListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocationListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLocationChanged</span><span class="o">(</span><span class="n">Location</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">DeviceIdleController</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">receivedGpsLocationLocked</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">......</span>
    <span class="o">};</span>
</code></pre>
</div>

<h4 id="receivedgpslocationlockedgps">2.14 receivedGpsLocationLocked方法接收GPS位置信息</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">receivedGpsLocationLocked</span><span class="o">(</span><span class="n">Location</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">!=</span> <span class="n">STATE_LOCATING</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">cancelLocatingLocked</span><span class="o">();</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"GPS location: "</span> <span class="o">+</span> <span class="n">location</span><span class="o">);</span>
        <span class="n">mLastGpsLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Location</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">getAccuracy</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">LOCATION_ACCURACY</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mLocated</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mNotMoving</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">stepIdleStateLocked</span><span class="o">(</span><span class="s">"s:gps"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="locating---idlemaintenance----idle----idlemaintenance">三、LOCATING -&gt; IDLE_MAINTENANCE –&gt; IDLE –&gt; IDLE_MAINTENANCE状态切换</h3>

<p>时序图：</p>

<p><img src="https://xiezeyangcn.github.io/xzyblog.github.io/assets/images/2017-11-26-deep-doze-mode/location_idlemaintenance_idle_idlemaintenance.bmp" alt="" /></p>

<h4 id="stepidlestatelocked-2">3.1 stepIdleStateLocked</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mState</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">STATE_LOCATING:</span>
            <span class="n">cancelAlarmLocked</span><span class="o">();</span>
            <span class="n">cancelLocatingLocked</span><span class="o">();</span>
            <span class="n">mAnyMotionDetector</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="cancelalarmlockeddeepalarm">3.2 cancelAlarmLocked方法取消DeepAlarm监听</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">cancelAlarmLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mNextAlarmTime</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mNextAlarmTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="n">mDeepAlarmListener</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="cancellocatinglockedgenericgps">3.3 cancelLocatingLocked方法取消定位监听（Generic、Gps）</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">cancelLocatingLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mLocating</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// STATE_SENSING下注册mGenericLocationListener、mGpsLocationListener监听器</span>
        <span class="n">mLocationManager</span><span class="o">.</span><span class="na">removeUpdates</span><span class="o">(</span><span class="n">mGenericLocationListener</span><span class="o">);</span>
        <span class="n">mLocationManager</span><span class="o">.</span><span class="na">removeUpdates</span><span class="o">(</span><span class="n">mGpsLocationListener</span><span class="o">);</span>
        <span class="n">mLocating</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="anymotiondetectorstoponanymotionresult">3.4 AnyMotionDetector函数stop方法回调onAnyMotionResult方法</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">==</span> <span class="n">STATE_ACTIVE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mState</span> <span class="o">=</span> <span class="n">STATE_INACTIVE</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved from STATE_ACTIVE to STATE_INACTIVE."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">removeCallbacks</span><span class="o">(</span><span class="n">mMeasurementTimeout</span><span class="o">);</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">removeCallbacks</span><span class="o">(</span><span class="n">mSensorRestart</span><span class="o">);</span>
        <span class="n">mMeasurementTimeoutIsActive</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">mSensorRestartIsActive</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mMeasurementInProgress</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mMeasurementInProgress</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">mSensorManager</span><span class="o">.</span><span class="na">unregisterListener</span><span class="o">(</span><span class="n">mListener</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">mCurrentGravityVector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">mPreviousGravityVector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mWakeLock</span><span class="o">.</span><span class="na">isHeld</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">mHandler</span><span class="o">.</span><span class="na">removeCallbacks</span><span class="o">(</span><span class="n">mWakelockTimeout</span><span class="o">);</span>
            <span class="n">mWakelockTimeoutIsActive</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">mWakeLock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="onanymotionresultstepidlestatelocked">3.5 onAnyMotionResult方法调用stepIdleStateLocked切换状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnyMotionResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">result</span> <span class="o">==</span> <span class="n">AnyMotionDetector</span><span class="o">.</span><span class="na">RESULT_MOVED</span><span class="o">)</span> <span class="o">||</span>
        <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">AnyMotionDetector</span><span class="o">.</span><span class="na">RESULT_UNKNOWN</span><span class="o">))</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handleMotionDetectedLocked</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">INACTIVE_TIMEOUT</span><span class="o">,</span> <span class="s">"non_stationary"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">AnyMotionDetector</span><span class="o">.</span><span class="na">RESULT_STATIONARY</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">==</span> <span class="n">STATE_SENSING</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">......</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">==</span> <span class="n">STATE_LOCATING</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 如果当前处于LOCATING状态，则通过mLocated来决定是否切换状态</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mNotMoving</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mLocated</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">stepIdleStateLocked</span><span class="o">(</span><span class="s">"s:stationary"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="stepidlestatelockedsdlemaintenance">3.6 stepIdleStateLocked方法切换至SDLE_MAINTENANCE状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mState</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">STATE_IDLE_MAINTENANCE:</span>
            <span class="n">scheduleAlarmLocked</span><span class="o">(</span><span class="n">mNextIdleDelay</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved to STATE_IDLE. Next alarm in "</span> <span class="o">+</span> <span class="n">mNextIdleDelay</span> <span class="o">+</span>
                <span class="s">" ms."</span><span class="o">);</span>
            <span class="c1">// 60分钟乘以2</span>
            <span class="n">mNextIdleDelay</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)(</span><span class="n">mNextIdleDelay</span> <span class="o">*</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">IDLE_FACTOR</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Setting mNextIdleDelay = "</span> <span class="o">+</span> <span class="n">mNextIdleDelay</span><span class="o">);</span>
            <span class="c1">// 同6小时比较取小的</span>
            <span class="n">mNextIdleDelay</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">mNextIdleDelay</span><span class="o">,</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">MAX_IDLE_TIMEOUT</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mNextIdleDelay</span> <span class="o">&lt;</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">IDLE_TIMEOUT</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mNextIdleDelay</span> <span class="o">=</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">IDLE_TIMEOUT</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">mState</span> <span class="o">=</span> <span class="n">STATE_IDLE</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mLightState</span> <span class="o">!=</span> <span class="n">LIGHT_STATE_OVERRIDE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mLightState</span> <span class="o">=</span> <span class="n">LIGHT_STATE_OVERRIDE</span><span class="o">;</span>
            <span class="n">cancelLightAlarmLocked</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdle</span><span class="o">(</span><span class="n">mState</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
            <span class="n">addEvent</span><span class="o">(</span><span class="n">EVENT_DEEP_IDLE</span><span class="o">);</span>
            <span class="n">mGoingIdleWakeLock</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
            <span class="n">mHandler</span><span class="o">.</span><span class="na">sendEmptyMessage</span><span class="o">(</span><span class="n">MSG_REPORT_IDLE_ON</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">......</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="schedulealarmlockedalarmidle">3.7 scheduleAlarmLocked方法设置Alarm监听直至进入IDLE模式</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">scheduleAlarmLocked</span><span class="o">(</span><span class="kt">long</span> <span class="n">delay</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">idleUntil</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"scheduleAlarmLocked("</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">idleUntil</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mMotionSensor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 如果设备没有运动传感器，则不安排时钟，因为无法确定设备是否移动</span>
        <span class="c1">// 这有效关闭了设备空闲的正常执行，尽管仍然可能假装像关闭闹钟一样去拨动它</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mNextAlarmTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">+</span> <span class="n">delay</span><span class="o">;</span>
        <span class="c1">// 设置AlarmListener监听器，调用stepIdleStateLocked方法做状态切换</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">idleUntil</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">setIdleUntil</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span>
            <span class="n">mNextAlarmTime</span><span class="o">,</span> <span class="s">"DeviceIdleController.deep"</span><span class="o">,</span> <span class="n">mDeepAlarmListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span>
            <span class="n">mNextAlarmTime</span><span class="o">,</span> <span class="s">"DeviceIdleController.deep"</span><span class="o">,</span> <span class="n">mDeepAlarmListener</span><span class="o">,</span> <span class="n">mHandler</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="cancellightalarmlockedlightalarm">3.8 cancelLightAlarmLocked方法取消LightAlarm监听</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">cancelLightAlarmLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mNextLightAlarmTime</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mNextLightAlarmTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">mAlarmManager</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="n">mLightAlarmListener</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AlarmManager</span><span class="o">.</span><span class="na">OnAlarmListener</span> <span class="n">mLightAlarmListener</span>
        <span class="o">=</span> <span class="k">new</span> <span class="n">AlarmManager</span><span class="o">.</span><span class="na">OnAlarmListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAlarm</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">DeviceIdleController</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stepLightIdleStateLocked</span><span class="o">(</span><span class="s">"s:alarm"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
</code></pre>
</div>

<h4 id="msgreportidleonlightidledeepidle">3.9 发送MSG_REPORT_IDLE_ON消息，退出LightIdle模式，进入DeepIdle模式</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MyHandler</span> <span class="kd">extends</span> <span class="n">Handler</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"handleMessage("</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">......</span>
            <span class="k">case</span> <span class="nl">MSG_REPORT_IDLE_ON:</span>
            <span class="k">case</span> <span class="nl">MSG_REPORT_IDLE_ON_LIGHT:</span> <span class="o">{</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleOnStart</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">deepChanged</span><span class="o">;</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">lightChanged</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">==</span> <span class="n">MSG_REPORT_IDLE_ON</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">deepChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setDeviceIdleMode</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="n">lightChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setLightDeviceIdleMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">deepChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setDeviceIdleMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="n">lightChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setLightDeviceIdleMode</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">mNetworkPolicyManager</span><span class="o">.</span><span class="na">setDeviceIdleMode</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="n">mBatteryStats</span><span class="o">.</span><span class="na">noteDeviceIdleMode</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">==</span> <span class="n">MSG_REPORT_IDLE_ON</span>
                    <span class="o">?</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">DEVICE_IDLE_MODE_DEEP</span>
                    <span class="o">:</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">DEVICE_IDLE_MODE_LIGHT</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">myUid</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">deepChanged</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">getContext</span><span class="o">().</span><span class="na">sendBroadcastAsUser</span><span class="o">(</span><span class="n">mIdleIntent</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">ALL</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lightChanged</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">getContext</span><span class="o">().</span><span class="na">sendBroadcastAsUser</span><span class="o">(</span><span class="n">mLightIdleIntent</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">ALL</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleOnComplete</span><span class="o">();</span>
            <span class="n">mGoingIdleWakeLock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">break</span><span class="o">;</span>
            <span class="o">......</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="stepidlestatelockedidlemaintenance">3.10 stepIdleStateLocked方法切换至IDLE_MAINTENANCE状态</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">stepIdleStateLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mState</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="k">case</span> <span class="nl">STATE_IDLE:</span>
            <span class="n">mActiveIdleOpCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
            <span class="n">mActiveIdleWakeLock</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
            <span class="n">scheduleAlarmLocked</span><span class="o">(</span><span class="n">mNextIdlePendingDelay</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Moved from STATE_IDLE to STATE_IDLE_MAINTENANCE. "</span> <span class="o">+</span>
                <span class="s">"Next alarm in "</span> <span class="o">+</span> <span class="n">mNextIdlePendingDelay</span> <span class="o">+</span> <span class="s">" ms."</span><span class="o">);</span>
            <span class="n">mMaintenanceStartTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
            <span class="n">mNextIdlePendingDelay</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">mConstants</span><span class="o">.</span><span class="na">MAX_IDLE_PENDING_TIMEOUT</span><span class="o">,</span>
                <span class="o">(</span><span class="kt">long</span><span class="o">)(</span><span class="n">mNextIdlePendingDelay</span> <span class="o">*</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">IDLE_PENDING_FACTOR</span><span class="o">));</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mNextIdlePendingDelay</span> <span class="o">&lt;</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">IDLE_PENDING_TIMEOUT</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mNextIdlePendingDelay</span> <span class="o">=</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">IDLE_PENDING_TIMEOUT</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">mState</span> <span class="o">=</span> <span class="n">STATE_IDLE_MAINTENANCE</span><span class="o">;</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdle</span><span class="o">(</span><span class="n">mState</span><span class="o">,</span> <span class="n">reason</span><span class="o">);</span>
            <span class="n">addEvent</span><span class="o">(</span><span class="n">EVENT_DEEP_MAINTENANCE</span><span class="o">);</span>
            <span class="n">mHandler</span><span class="o">.</span><span class="na">sendEmptyMessage</span><span class="o">(</span><span class="n">MSG_REPORT_IDLE_OFF</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="msgreportidleoffidle">3.11 发送MSG_REPORT_IDLE_OFF消息退出Idle模式</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MyHandler</span> <span class="kd">extends</span> <span class="n">Handler</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"handleMessage("</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">......</span>
            <span class="k">case</span> <span class="nl">MSG_REPORT_IDLE_OFF:</span> <span class="o">{</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleOffStart</span><span class="o">(</span><span class="s">"unknown"</span><span class="o">);</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">deepChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setDeviceIdleMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">lightChanged</span> <span class="o">=</span> <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setLightDeviceIdleMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">mNetworkPolicyManager</span><span class="o">.</span><span class="na">setDeviceIdleMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="n">mBatteryStats</span><span class="o">.</span><span class="na">noteDeviceIdleMode</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">DEVICE_IDLE_MODE_OFF</span><span class="o">,</span>
                    <span class="kc">null</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">myUid</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">deepChanged</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">incActiveIdleOps</span><span class="o">();</span>
                <span class="n">getContext</span><span class="o">().</span><span class="na">sendOrderedBroadcastAsUser</span><span class="o">(</span><span class="n">mIdleIntent</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>
                    <span class="kc">null</span><span class="o">,</span> <span class="n">mIdleStartedDoneReceiver</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lightChanged</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">incActiveIdleOps</span><span class="o">();</span>
                <span class="n">getContext</span><span class="o">().</span><span class="na">sendOrderedBroadcastAsUser</span><span class="o">(</span><span class="n">mLightIdleIntent</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span>
                    <span class="kc">null</span><span class="o">,</span> <span class="n">mIdleStartedDoneReceiver</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">decActiveIdleOps</span><span class="o">();</span>
            <span class="n">EventLogTags</span><span class="o">.</span><span class="na">writeDeviceIdleOffComplete</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">break</span><span class="o">;</span>
            <span class="o">......</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>
