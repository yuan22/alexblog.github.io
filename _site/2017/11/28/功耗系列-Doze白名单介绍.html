<h3 id="section">一、三种情况处理</h3>

<h4 id="system-excidle-system-app--used-for-doze">1.1 System-excidle (system app) : used for doze</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>    ArrayMap&lt;String, Interger&gt; mPowerSaveWhitelistAppsExceptIdle
    String: packageName
    Interger: app Uid
    From etc/permissions/platform.xml tag: allow-in-power-save-except-idle (SystemConfig.mAllowInPowerSaveExceptIdle)
</code></pre>
</div>

<h4 id="system-system-app--used-for-doze--app-standby">1.2 System (system app) : used for doze &amp; app standby</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>    ArrayMap&lt;String, Interger&gt; mPowerSaveWhitelistApps
    From etc/permissions/platform.xml tag : allow-in-power-save (SystemConfig.mAllowInPowerSave)
</code></pre>
</div>

<h4 id="user---used-for-doze--app-standby">1.3 User :  used for doze &amp; app standby</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>    ArrayMap&lt;String,Interger&gt; mPowerSaveWhitelistUserApps
    From data/system/deviceidle.xml tag: wl
    The app uid’s array will be set to PowerMS as wakelock whitelist
</code></pre>
</div>

<h3 id="doze">二、Doze白名单</h3>

<h4 id="onstart-doze">2.1 onStart方法-Doze白名单服务</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">PackageManager</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getPackageManager</span><span class="o">();</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 默认为false,需要GCM相关服务支持；true表示打开自动省电模式。</span>
        <span class="n">mLightEnabled</span> <span class="o">=</span> <span class="n">mDeepEnabled</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getResources</span><span class="o">().</span><span class="na">getBoolean</span><span class="o">(</span>
            <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">bool</span><span class="o">.</span><span class="na">config_enableAutoPowerModes</span><span class="o">);</span>
        <span class="n">SystemConfig</span> <span class="n">sysConfig</span> <span class="o">=</span> <span class="n">SystemConfig</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
        <span class="n">ArraySet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">allowPowerExceptIdle</span> <span class="o">=</span> <span class="n">sysConfig</span><span class="o">.</span><span class="na">getAllowInPowerSaveExceptIdle</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">allowPowerExceptIdle</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">allowPowerExceptIdle</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
            <span class="n">ApplicationInfo</span> <span class="n">ai</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">getApplicationInfo</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span>
                <span class="n">PackageManager</span><span class="o">.</span><span class="na">MATCH_SYSTEM_ONLY</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">appid</span> <span class="o">=</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">getAppId</span><span class="o">(</span><span class="n">ai</span><span class="o">.</span><span class="na">uid</span><span class="o">);</span>
            <span class="n">mPowerSaveWhitelistAppsExceptIdle</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ai</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">appid</span><span class="o">);</span>
            <span class="n">mPowerSaveWhitelistSystemAppIdsExceptIdle</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">appid</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PackageManager</span><span class="o">.</span><span class="na">NameNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">ArraySet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">allowPower</span> <span class="o">=</span> <span class="n">sysConfig</span><span class="o">.</span><span class="na">getAllowInPowerSave</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">allowPower</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">allowPower</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
            <span class="n">ApplicationInfo</span> <span class="n">ai</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">getApplicationInfo</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span>
                <span class="n">PackageManager</span><span class="o">.</span><span class="na">MATCH_SYSTEM_ONLY</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">appid</span> <span class="o">=</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">getAppId</span><span class="o">(</span><span class="n">ai</span><span class="o">.</span><span class="na">uid</span><span class="o">);</span>
            <span class="n">mPowerSaveWhitelistAppsExceptIdle</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ai</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">appid</span><span class="o">);</span>
            <span class="n">mPowerSaveWhitelistSystemAppIdsExceptIdle</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">appid</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="n">mPowerSaveWhitelistApps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ai</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">appid</span><span class="o">);</span>
            <span class="n">mPowerSaveWhitelistSystemAppIds</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">appid</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PackageManager</span><span class="o">.</span><span class="na">NameNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">mConstants</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Constants</span><span class="o">(</span><span class="n">mHandler</span><span class="o">,</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">());</span>
        <span class="n">readConfigFileLocked</span><span class="o">();</span>
        <span class="n">updateWhitelistAppIdsLocked</span><span class="o">();</span>
        <span class="n">mNetworkConnected</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">mScreenOn</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="c1">// 假定正在充电；电量下降时更新状态。</span>
        <span class="n">mCharging</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">mState</span> <span class="o">=</span> <span class="n">STATE_ACTIVE</span><span class="o">;</span>
        <span class="n">mLightState</span> <span class="o">=</span> <span class="n">LIGHT_STATE_ACTIVE</span><span class="o">;</span>
        <span class="n">mInactiveTimeout</span> <span class="o">=</span> <span class="n">mConstants</span><span class="o">.</span><span class="na">INACTIVE_TIMEOUT</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mBinderService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BinderService</span><span class="o">();</span>
        <span class="n">publishBinderService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">DEVICE_IDLE_CONTROLLER</span><span class="o">,</span> <span class="n">mBinderService</span><span class="o">);</span>
        <span class="n">publishLocalService</span><span class="o">(</span><span class="n">LocalService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">LocalService</span><span class="o">());</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="binderservice---doze">2.2 BinderService - 处理Doze白名单</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">BinderService</span> <span class="kd">extends</span> <span class="n">IDeviceIdleController</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
        <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addPowerSaveWhitelistApp</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">enforceCallingOrSelfPermission</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">DEVICE_POWER</span><span class="o">,</span>
            <span class="kc">null</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">ident</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">addPowerSaveWhitelistAppInternal</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">ident</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removePowerSaveWhitelistApp</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">enforceCallingOrSelfPermission</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">DEVICE_POWER</span><span class="o">,</span>
            <span class="kc">null</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">ident</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">removePowerSaveWhitelistAppInternal</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">ident</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">getSystemPowerWhitelistExceptIdle</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getSystemPowerWhitelistExceptIdleInternal</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="o">......</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="addpowersavewhitelistappinternal-doze">2.3 addPowerSaveWhitelistAppInternal方法-将其加入到Doze白名单</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addPowerSaveWhitelistAppInternal</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ApplicationInfo</span> <span class="n">ai</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getPackageManager</span><span class="o">().</span><span class="na">getApplicationInfo</span><span class="o">(</span><span class="n">name</span><span class="o">,</span>
                <span class="n">PackageManager</span><span class="o">.</span><span class="na">MATCH_UNINSTALLED_PACKAGES</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mPowerSaveWhitelistUserApps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">getAppId</span><span class="o">(</span><span class="n">ai</span><span class="o">.</span><span class="na">uid</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">reportPowerSaveWhitelistChangedLocked</span><span class="o">();</span>
            <span class="n">updateWhitelistAppIdsLocked</span><span class="o">();</span>
            <span class="n">writeConfigFileLocked</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PackageManager</span><span class="o">.</span><span class="na">NameNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="removepowersavewhitelistappinternal-doze">2.4 removePowerSaveWhitelistAppInternal方法-从Doze白名单中移除</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removePowerSaveWhitelistAppInternal</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mPowerSaveWhitelistUserApps</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">reportPowerSaveWhitelistChangedLocked</span><span class="o">();</span>
            <span class="n">updateWhitelistAppIdsLocked</span><span class="o">();</span>
            <span class="n">writeConfigFileLocked</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="reportpowersavewhitelistchangedlocked-doze">2.5 reportPowerSaveWhitelistChangedLocked方法-发送Doze白名单变化广播</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">reportPowerSaveWhitelistChangedLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">PowerManager</span><span class="o">.</span><span class="na">ACTION_POWER_SAVE_WHITELIST_CHANGED</span><span class="o">);</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="o">);</span>
        <span class="n">getContext</span><span class="o">().</span><span class="na">sendBroadcastAsUser</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">SYSTEM</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="updatewhitelistappidslocked-doze">2.6 updateWhitelistAppIdsLocked方法-更新Doze白名单信息</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateWhitelistAppIdsLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">mPowerSaveWhitelistExceptIdleAppIdArray</span> <span class="o">=</span> <span class="n">buildAppIdArray</span><span class="o">(</span><span class="n">mPowerSaveWhitelistAppsExceptIdle</span><span class="o">,</span>
            <span class="n">mPowerSaveWhitelistUserApps</span><span class="o">,</span> <span class="n">mPowerSaveWhitelistExceptIdleAppIds</span><span class="o">);</span>
        <span class="n">mPowerSaveWhitelistAllAppIdArray</span> <span class="o">=</span> <span class="n">buildAppIdArray</span><span class="o">(</span><span class="n">mPowerSaveWhitelistApps</span><span class="o">,</span>
            <span class="n">mPowerSaveWhitelistUserApps</span><span class="o">,</span> <span class="n">mPowerSaveWhitelistAllAppIds</span><span class="o">);</span>
        <span class="n">mPowerSaveWhitelistUserAppIdArray</span> <span class="o">=</span> <span class="n">buildAppIdArray</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span>
            <span class="n">mPowerSaveWhitelistUserApps</span><span class="o">,</span> <span class="n">mPowerSaveWhitelistUserAppIds</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mLocalPowerManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Setting wakelock whitelist to "</span>
                <span class="o">+</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">mPowerSaveWhitelistAllAppIdArray</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">mLocalPowerManager</span><span class="o">.</span><span class="na">setDeviceIdleWhitelist</span><span class="o">(</span><span class="n">mPowerSaveWhitelistAllAppIdArray</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mLocalAlarmManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Setting alarm whitelist to "</span>
                <span class="o">+</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">mPowerSaveWhitelistUserAppIdArray</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">mLocalAlarmManager</span><span class="o">.</span><span class="na">setDeviceIdleUserWhitelist</span><span class="o">(</span><span class="n">mPowerSaveWhitelistUserAppIdArray</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="writeconfigfilelocked-config">2.7 writeConfigFileLocked方法-写入config文件</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kt">void</span> <span class="nf">writeConfigFileLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">removeMessages</span><span class="o">(</span><span class="n">MSG_WRITE_CONFIG</span><span class="o">);</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">sendEmptyMessageDelayed</span><span class="o">(</span><span class="n">MSG_WRITE_CONFIG</span><span class="o">,</span> <span class="mi">5000</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

