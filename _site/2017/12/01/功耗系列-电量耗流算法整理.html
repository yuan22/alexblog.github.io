<h3 id="processappusage">一、软件功耗processAppUsage方法</h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processAppUsage</span><span class="o">(</span><span class="n">SparseArray</span><span class="o">&lt;</span><span class="n">UserHandle</span><span class="o">&gt;</span> <span class="n">asUsers</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 判断是否统计所有用户app耗电情况，forAllUsers默认为true</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">forAllUsers</span> <span class="o">=</span> <span class="o">(</span><span class="n">asUsers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">UserHandle</span><span class="o">.</span><span class="na">USER_ALL</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
        <span class="c1">// 耗电的统计时长</span>
        <span class="n">mStatsPeriod</span> <span class="o">=</span> <span class="n">mTypeBatteryRealtimeUs</span><span class="o">;</span>
        <span class="n">BatterySipper</span> <span class="n">osSipper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// 获取每个uid的统计信息</span>
        <span class="kd">final</span> <span class="n">SparseArray</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Uid</span><span class="o">&gt;</span> <span class="n">uidStats</span> <span class="o">=</span> <span class="n">mStats</span><span class="o">.</span><span class="na">getUidStats</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">NU</span> <span class="o">=</span> <span class="n">uidStats</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="c1">// 遍历每个uid耗电情况</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">iu</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">iu</span> <span class="o">&lt;</span> <span class="n">NU</span><span class="o">;</span> <span class="n">iu</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">Uid</span> <span class="n">u</span> <span class="o">=</span> <span class="n">uidStats</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">iu</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">BatterySipper</span> <span class="n">app</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatterySipper</span><span class="o">(</span><span class="n">BatterySipper</span><span class="o">.</span><span class="na">DrainType</span><span class="o">.</span><span class="na">APP</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="c1">// 计算cpu功耗</span>
        <span class="n">mCpuPowerCalculator</span><span class="o">.</span><span class="na">calculateApp</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">);</span>
        <span class="c1">// 计算wakelock功耗</span>
        <span class="n">mWakelockPowerCalculator</span><span class="o">.</span><span class="na">calculateApp</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">);</span>
        <span class="c1">// 计算移动radio功耗</span>
        <span class="n">mMobileRadioPowerCalculator</span><span class="o">.</span><span class="na">calculateApp</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">);</span>
        <span class="c1">// 计算wifi功耗</span>
        <span class="n">mWifiPowerCalculator</span><span class="o">.</span><span class="na">calculateApp</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">);</span>
        <span class="c1">// 计算蓝牙功耗</span>
        <span class="n">mBluetoothPowerCalculator</span><span class="o">.</span><span class="na">calculateApp</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">);</span>
        <span class="c1">// 计算sensor传感器功耗</span>
        <span class="n">mSensorPowerCalculator</span><span class="o">.</span><span class="na">calculateApp</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">);</span>
        <span class="c1">// 计算相机功耗</span>
        <span class="n">mCameraPowerCalculator</span><span class="o">.</span><span class="na">calculateApp</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">);</span>
        <span class="c1">// 计算闪光灯功耗</span>
        <span class="n">mFlashlightPowerCalculator</span><span class="o">.</span><span class="na">calculateApp</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">u</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">);</span>
        <span class="c1">// 累加上述8项耗电</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">totalPower</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">sumPower</span><span class="o">();</span>
        <span class="c1">// 如果耗电，将app添加到app列表，WiFi、Bluetooth或其它用户列表</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">totalPower</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">u</span><span class="o">.</span><span class="na">getUid</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">getUid</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(</span><span class="n">uid</span><span class="o">);</span>
            <span class="c1">// uid为wifi的情况</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">uid</span> <span class="o">==</span> <span class="n">Process</span><span class="o">.</span><span class="na">WIFI_UID</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mWifiSippers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
            <span class="c1">// uid为蓝牙的情况</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">uid</span> <span class="o">==</span> <span class="n">Process</span><span class="o">.</span><span class="na">BLUETOOTH_UID</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mBluetoothSippers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
            <span class="c1">// forAllUsers为true,不会进入</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">forAllUsers</span> <span class="o">&amp;&amp;</span> <span class="n">asUsers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span>
                <span class="o">&amp;&amp;</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">getAppId</span><span class="o">(</span><span class="n">uid</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">Process</span><span class="o">.</span><span class="na">FIRST_APPLICATION_UID</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">BatterySipper</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">mUserSippers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">list</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
                <span class="n">mUserSippers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 把app耗电加入到mUsageList中</span>
            <span class="n">mUsageList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// root用户，即os耗电</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">uid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">osSipper</span> <span class="o">=</span> <span class="n">app</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">osSipper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// app之外耗电</span>
        <span class="n">mWakelockPowerCalculator</span><span class="o">.</span><span class="na">calculateRemaining</span><span class="o">(</span><span class="n">osSipper</span><span class="o">,</span> <span class="n">mStats</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span>
            <span class="n">mRawUptimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">);</span>
        <span class="n">osSipper</span><span class="o">.</span><span class="na">sumPower</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>公式：
软件功耗 = CPU功耗 + Wakelock功耗 + Wi-Fi功耗 + Bluetooth功耗 + Mobile Radio功耗 + Sensor功耗 + Camera功耗 + Flashlight功耗</p>

<h4 id="cpu">1.1 CPU功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nf">CpuPowerCalculator</span><span class="o">(</span><span class="n">PowerProfile</span> <span class="n">profile</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mProfile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateApp</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span> <span class="n">u</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">app</span><span class="o">.</span><span class="na">cpuTimeMs</span> <span class="o">=</span> <span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="na">getUserCpuTimeUs</span><span class="o">(</span><span class="n">statsType</span><span class="o">)</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="na">getSystemCpuTimeUs</span><span class="o">(</span><span class="n">statsType</span><span class="o">))</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="c1">// 合并统计每个集群上耗费的时间，即cpu总共的运行时间</span>
        <span class="kt">long</span> <span class="n">totalTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">numClusters</span> <span class="o">=</span> <span class="n">mProfile</span><span class="o">.</span><span class="na">getNumCpuClusters</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">cluster</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">cluster</span> <span class="o">&lt;</span> <span class="n">numClusters</span><span class="o">;</span> <span class="n">cluster</span><span class="o">++)</span> <span class="o">{</span>
        <span class="c1">// 获取cpu集群上主频级数（运行速度）</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">speedsForCluster</span> <span class="o">=</span> <span class="n">mProfile</span><span class="o">.</span><span class="na">getNumSpeedStepsInCpuCluster</span><span class="o">(</span><span class="n">cluster</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="n">speedsForCluster</span><span class="o">;</span> <span class="n">speed</span><span class="o">++)</span> <span class="o">{</span>
            <span class="c1">// 获取cpu不同频点下运行时间</span>
            <span class="n">totalTime</span> <span class="o">+=</span> <span class="n">u</span><span class="o">.</span><span class="na">getTimeAtCpuSpeed</span><span class="o">(</span><span class="n">cluster</span><span class="o">,</span> <span class="n">speed</span><span class="o">,</span> <span class="n">statsType</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">totalTime</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">totalTime</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="c1">// cpu耗电量</span>
        <span class="kt">double</span> <span class="n">cpuPowerMaMs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">cluster</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">cluster</span> <span class="o">&lt;</span> <span class="n">numClusters</span><span class="o">;</span> <span class="n">cluster</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">speedsForCluster</span> <span class="o">=</span> <span class="n">mProfile</span><span class="o">.</span><span class="na">getNumSpeedStepsInCpuCluster</span><span class="o">(</span><span class="n">cluster</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="n">speedsForCluster</span><span class="o">;</span> <span class="n">speed</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">double</span> <span class="n">ratio</span> <span class="o">=</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">u</span><span class="o">.</span><span class="na">getTimeAtCpuSpeed</span><span class="o">(</span><span class="n">cluster</span><span class="o">,</span> <span class="n">speed</span><span class="o">,</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">/</span>
                <span class="n">totalTime</span><span class="o">;</span>
            <span class="kd">final</span> <span class="kt">double</span> <span class="n">cpuSpeedStepPower</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">app</span><span class="o">.</span><span class="na">cpuTimeMs</span> <span class="o">*</span>
                <span class="n">mProfile</span><span class="o">.</span><span class="na">getAveragePowerForCpu</span><span class="o">(</span><span class="n">cluster</span><span class="o">,</span> <span class="n">speed</span><span class="o">);</span>
            <span class="n">cpuPowerMaMs</span> <span class="o">+=</span> <span class="n">cpuSpeedStepPower</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// 转换为mAh</span>
        <span class="n">app</span><span class="o">.</span><span class="na">cpuPowerMah</span> <span class="o">=</span> <span class="n">cpuPowerMaMs</span> <span class="o">/</span> <span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="c1">// 统计追踪最高功耗的包</span>
        <span class="kt">double</span> <span class="n">highestDrain</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">cpuFgTimeMs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span><span class="o">.</span><span class="na">Proc</span><span class="o">&gt;</span> <span class="n">processStats</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getProcessStats</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">processStatsCount</span> <span class="o">=</span> <span class="n">processStats</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="c1">// 统计同一个uid不同进程的功耗</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">processStatsCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span><span class="o">.</span><span class="na">Proc</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">processStats</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">processName</span> <span class="o">=</span> <span class="n">processStats</span><span class="o">.</span><span class="na">keyAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">cpuFgTimeMs</span> <span class="o">+=</span> <span class="n">ps</span><span class="o">.</span><span class="na">getForegroundTime</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">costValue</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="na">getUserTime</span><span class="o">(</span><span class="n">statsType</span><span class="o">)</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="na">getSystemTime</span><span class="o">(</span><span class="n">statsType</span><span class="o">)</span>
            <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="na">getForegroundTime</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="c1">// 应用可能有多个包或多个进程，追踪功耗最高的进程</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">packageWithHighestDrain</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
            <span class="n">app</span><span class="o">.</span><span class="na">packageWithHighestDrain</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"*"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">highestDrain</span> <span class="o">=</span> <span class="n">costValue</span><span class="o">;</span>
            <span class="n">app</span><span class="o">.</span><span class="na">packageWithHighestDrain</span> <span class="o">=</span> <span class="n">processName</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">highestDrain</span> <span class="o">&lt;</span> <span class="n">costValue</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">processName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"*"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">highestDrain</span> <span class="o">=</span> <span class="n">costValue</span><span class="o">;</span>
            <span class="n">app</span><span class="o">.</span><span class="na">packageWithHighestDrain</span> <span class="o">=</span> <span class="n">processName</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// 确保cpu时间合理</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">cpuFgTimeMs</span> <span class="o">&gt;</span> <span class="n">app</span><span class="o">.</span><span class="na">cpuTimeMs</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 当cpu前台时间大于cpu时间时，统计数据可能尚未收集，将cpu前台时间赋给cpu时间</span>
        <span class="n">app</span><span class="o">.</span><span class="na">cpuTimeMs</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">cpuFgTimeMs</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
CPU单个频点功耗　＝　ratio * app.cpuTimeMs *
    mProfile.getAveragePowerForCpu(cluster, speed);</p>

<h4 id="wakelock">1.2 WakeLock功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nf">WakelockPowerCalculator</span><span class="o">(</span><span class="n">PowerProfile</span> <span class="n">profile</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mPowerWakelock</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_CPU_AWAKE</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateApp</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span> <span class="n">u</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">wakeLockTimeUs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span><span class="o">.</span><span class="na">Wakelock</span><span class="o">&gt;</span> <span class="n">wakelockStats</span> <span class="o">=</span>
            <span class="n">u</span><span class="o">.</span><span class="na">getWakelockStats</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">wakelockStatsCount</span> <span class="o">=</span> <span class="n">wakelockStats</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wakelockStatsCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span><span class="o">.</span><span class="na">Wakelock</span> <span class="n">wakelock</span> <span class="o">=</span> <span class="n">wakelockStats</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="c1">// 由于用户关闭屏幕时full wakelock被自动取消，只统计partial wakelockk</span>
        <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Timer</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">wakelock</span><span class="o">.</span><span class="na">getWakeTime</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">WAKE_TYPE_PARTIAL</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">timer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">wakeLockTimeUs</span> <span class="o">+=</span> <span class="n">timer</span><span class="o">.</span><span class="na">getTotalTimeLocked</span><span class="o">(</span><span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="n">statsType</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// 转换为秒</span>
        <span class="n">app</span><span class="o">.</span><span class="na">wakeLockTimeMs</span> <span class="o">=</span> <span class="n">wakeLockTimeUs</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="n">mTotalAppWakelockTimeMs</span> <span class="o">+=</span> <span class="n">app</span><span class="o">.</span><span class="na">wakeLockTimeMs</span><span class="o">;</span>
        <span class="c1">// 计算唤醒消耗</span>
        <span class="n">app</span><span class="o">.</span><span class="na">wakeLockPowerMah</span> <span class="o">=</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">wakeLockTimeMs</span> <span class="o">*</span> <span class="n">mPowerWakelock</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
WakeLock功耗＝ (app.wakeLockTimeMs * mPowerWakelock) / (1000<em>60</em>60)</p>

<h4 id="mobile-radio">1.3 Mobile Radio功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// 预估接收、传输数据包的功率</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="nf">getMobilePowerPerPacket</span><span class="o">(</span><span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 从系统获取平均比特率</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">MOBILE_BPS</span> <span class="o">=</span> <span class="mi">200000</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">MOBILE_POWER</span> <span class="o">=</span> <span class="n">mPowerRadioOn</span> <span class="o">/</span> <span class="mi">3600</span><span class="o">;</span>
        <span class="c1">// 移动网络接收数据包</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">mobileRx</span> <span class="o">=</span> <span class="n">mStats</span><span class="o">.</span><span class="na">getNetworkActivityPackets</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_MOBILE_RX_DATA</span><span class="o">,</span>
            <span class="n">statsType</span><span class="o">);</span>
        <span class="c1">// 移动网络传输数据包</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">mobileTx</span> <span class="o">=</span> <span class="n">mStats</span><span class="o">.</span><span class="na">getNetworkActivityPackets</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_MOBILE_TX_DATA</span><span class="o">,</span>
            <span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">mobileData</span> <span class="o">=</span> <span class="n">mobileRx</span> <span class="o">+</span> <span class="n">mobileTx</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">radioDataUptimeMs</span> <span class="o">=</span>
            <span class="n">mStats</span><span class="o">.</span><span class="na">getMobileRadioActiveTime</span><span class="o">(</span><span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">mobilePps</span> <span class="o">=</span> <span class="o">(</span><span class="n">mobileData</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">radioDataUptimeMs</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
            <span class="o">?</span> <span class="o">(</span><span class="n">mobileData</span> <span class="o">/</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span><span class="n">radioDataUptimeMs</span><span class="o">)</span>
            <span class="o">:</span> <span class="o">(((</span><span class="kt">double</span><span class="o">)</span><span class="n">MOBILE_BPS</span><span class="o">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">2048</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">MOBILE_POWER</span> <span class="o">/</span> <span class="n">mobilePps</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MobileRadioPowerCalculator</span><span class="o">(</span><span class="n">PowerProfile</span> <span class="n">profile</span><span class="o">,</span> <span class="n">BatteryStats</span> <span class="n">stats</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mPowerRadioOn</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_RADIO_ACTIVE</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mPowerBins</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">mPowerBins</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_RADIO_ON</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">mPowerScan</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_RADIO_SCANNING</span><span class="o">);</span>
        <span class="n">mStats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateApp</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span> <span class="n">u</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 接收、传输移动流量的功耗</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileRxPackets</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getNetworkActivityPackets</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_MOBILE_RX_DATA</span><span class="o">,</span>
            <span class="n">statsType</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileTxPackets</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getNetworkActivityPackets</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_MOBILE_TX_DATA</span><span class="o">,</span>
            <span class="n">statsType</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileActive</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getMobileRadioActiveTime</span><span class="o">(</span><span class="n">statsType</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileActiveCount</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getMobileRadioActiveCount</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileRxBytes</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getNetworkActivityBytes</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_MOBILE_RX_DATA</span><span class="o">,</span>
            <span class="n">statsType</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileTxBytes</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getNetworkActivityBytes</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_MOBILE_TX_DATA</span><span class="o">,</span>
            <span class="n">statsType</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">mobileActive</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 当追踪到radio启用时，则用active时间来确定功耗</span>
        <span class="n">mTotalAppMobileActiveMs</span> <span class="o">+=</span> <span class="n">app</span><span class="o">.</span><span class="na">mobileActive</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileRadioPowerMah</span> <span class="o">=</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">mobileActive</span> <span class="o">*</span> <span class="n">mPowerRadioOn</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// 当没有追踪到radio启用时，则用收发数据包来估算功耗</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileRadioPowerMah</span> <span class="o">=</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">mobileRxPackets</span> <span class="o">+</span> <span class="n">app</span><span class="o">.</span><span class="na">mobileTxPackets</span><span class="o">)</span> <span class="o">*</span> <span class="n">getMobilePowerPerPacket</span><span class="o">(</span><span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="n">statsType</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
Mobile Radio功耗 = (app.mobileActive * mPowerRadioOn) / (1000<em>60</em>60)
或
Mobile Radio功耗 = (app.mobileRxPackets + app.mobileTxPackets)
    * getMobilePowerPerPacket(rawRealtimeUs, statsType)</p>

<h4 id="bluetooth">1.4 Bluetooth功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nf">BluetoothPowerCalculator</span><span class="o">(</span><span class="n">PowerProfile</span> <span class="n">profile</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mIdleMa</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_BLUETOOTH_CONTROLLER_IDLE</span><span class="o">);</span>
        <span class="n">mRxMa</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_BLUETOOTH_CONTROLLER_RX</span><span class="o">);</span>
        <span class="n">mTxMa</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_BLUETOOTH_CONTROLLER_TX</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateApp</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span> <span class="n">u</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">ControllerActivityCounter</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getBluetoothControllerActivity</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">counter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">idleTimeMs</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getIdleTimeCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">rxTimeMs</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getRxTimeCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">txTimeMs</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getTxTimeCounters</span><span class="o">()[</span><span class="mi">0</span><span class="o">].</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">totalTimeMs</span> <span class="o">=</span> <span class="n">idleTimeMs</span> <span class="o">+</span> <span class="n">txTimeMs</span> <span class="o">+</span> <span class="n">rxTimeMs</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">powerMah</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getPowerCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">)</span>
            <span class="o">/</span> <span class="o">(</span><span class="kt">double</span><span class="o">)(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">powerMah</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">powerMah</span> <span class="o">=</span> <span class="o">((</span><span class="n">idleTimeMs</span> <span class="o">*</span> <span class="n">mIdleMa</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">rxTimeMs</span> <span class="o">*</span> <span class="n">mRxMa</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">txTimeMs</span> <span class="o">*</span> <span class="n">mTxMa</span><span class="o">))</span>
            <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">app</span><span class="o">.</span><span class="na">bluetoothPowerMah</span> <span class="o">=</span> <span class="n">powerMah</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">bluetoothRunningTimeMs</span> <span class="o">=</span> <span class="n">totalTimeMs</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">btRxBytes</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getNetworkActivityBytes</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_BT_RX_DATA</span><span class="o">,</span> <span class="n">statsType</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">btTxBytes</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getNetworkActivityBytes</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_BT_TX_DATA</span><span class="o">,</span> <span class="n">statsType</span><span class="o">);</span>
        <span class="n">mAppTotalPowerMah</span> <span class="o">+=</span> <span class="n">powerMah</span><span class="o">;</span>
        <span class="n">mAppTotalTimeMs</span> <span class="o">+=</span> <span class="n">totalTimeMs</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
Bluetooth功耗 = ((idleTimeMs * mIdleMa) + (rxTimeMs * mRxMa) + (txTimeMs *
    mTxMa)) / (1000<em>60</em>60)</p>

<h4 id="wi-fi">1.5 Wi-Fi功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nf">WifiPowerCalculator</span><span class="o">(</span><span class="n">PowerProfile</span> <span class="n">profile</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mIdleCurrentMa</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_WIFI_CONTROLLER_IDLE</span><span class="o">);</span>
        <span class="n">mTxCurrentMa</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_WIFI_CONTROLLER_TX</span><span class="o">);</span>
        <span class="n">mRxCurrentMa</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_WIFI_CONTROLLER_RX</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateApp</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span> <span class="n">u</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">ControllerActivityCounter</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getWifiControllerActivity</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">counter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">idleTime</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getIdleTimeCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">txTime</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getTxTimeCounters</span><span class="o">()[</span><span class="mi">0</span><span class="o">].</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">rxTime</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getRxTimeCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="c1">// 计算wifi运行时间</span>
        <span class="n">app</span><span class="o">.</span><span class="na">wifiRunningTimeMs</span> <span class="o">=</span> <span class="n">idleTime</span> <span class="o">+</span> <span class="n">rxTime</span> <span class="o">+</span> <span class="n">txTime</span><span class="o">;</span>
        <span class="n">mTotalAppRunningTime</span> <span class="o">+=</span> <span class="n">app</span><span class="o">.</span><span class="na">wifiRunningTimeMs</span><span class="o">;</span>
        <span class="c1">// 计算wifi功耗</span>
        <span class="n">app</span><span class="o">.</span><span class="na">wifiPowerMah</span> <span class="o">=</span>
            <span class="o">((</span><span class="n">idleTime</span> <span class="o">*</span> <span class="n">mIdleCurrentMa</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">txTime</span> <span class="o">*</span> <span class="n">mTxCurrentMa</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">rxTime</span> <span class="o">*</span> <span class="n">mRxCurrentMa</span><span class="o">))</span>
            <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="n">mTotalAppPowerDrain</span> <span class="o">+=</span> <span class="n">app</span><span class="o">.</span><span class="na">wifiPowerMah</span><span class="o">;</span>

        <span class="n">app</span><span class="o">.</span><span class="na">wifiRxPackets</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getNetworkActivityPackets</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_WIFI_RX_DATA</span><span class="o">,</span>
            <span class="n">statsType</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">wifiTxPackets</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getNetworkActivityPackets</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_WIFI_TX_DATA</span><span class="o">,</span>
            <span class="n">statsType</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">wifiRxBytes</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getNetworkActivityBytes</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_WIFI_RX_DATA</span><span class="o">,</span>
            <span class="n">statsType</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">wifiTxBytes</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getNetworkActivityBytes</span><span class="o">(</span><span class="n">BatteryStats</span><span class="o">.</span><span class="na">NETWORK_WIFI_TX_DATA</span><span class="o">,</span>
            <span class="n">statsType</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
Wi-Fi功耗 ＝　((idleTime * mIdleCurrentMa) + (txTime * mTxCurrentMa) + (rxTime *
    mRxCurrentMa)) / (1000<em>60</em>60)</p>

<h4 id="sensor">1.6 Sensor功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nf">SensorPowerCalculator</span><span class="o">(</span><span class="n">PowerProfile</span> <span class="n">profile</span><span class="o">,</span> <span class="n">SensorManager</span> <span class="n">sensorManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mSensors</span> <span class="o">=</span> <span class="n">sensorManager</span><span class="o">.</span><span class="na">getSensorList</span><span class="o">(</span><span class="n">Sensor</span><span class="o">.</span><span class="na">TYPE_ALL</span><span class="o">);</span>
        <span class="n">mGpsPowerOn</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_GPS_ON</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateApp</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span> <span class="n">u</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// sensor进程功耗</span>
        <span class="kd">final</span> <span class="n">SparseArray</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span><span class="o">.</span><span class="na">Sensor</span><span class="o">&gt;</span> <span class="n">sensorStats</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getSensorStats</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">NSE</span> <span class="o">=</span> <span class="n">sensorStats</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">ise</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">ise</span> <span class="o">&lt;</span> <span class="n">NSE</span><span class="o">;</span> <span class="n">ise</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span><span class="o">.</span><span class="na">Sensor</span> <span class="n">sensor</span> <span class="o">=</span> <span class="n">sensorStats</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">ise</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">sensorHandle</span> <span class="o">=</span> <span class="n">sensorStats</span><span class="o">.</span><span class="na">keyAt</span><span class="o">(</span><span class="n">ise</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Timer</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">.</span><span class="na">getSensorTime</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">sensorTime</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="na">getTotalTimeLocked</span><span class="o">(</span><span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">sensorHandle</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// uid为GPS的情况</span>
            <span class="k">case</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span><span class="o">.</span><span class="na">Sensor</span><span class="o">.</span><span class="na">GPS</span><span class="o">:</span>
            <span class="n">app</span><span class="o">.</span><span class="na">gpsTimeMs</span> <span class="o">=</span> <span class="n">sensorTime</span><span class="o">;</span>
            <span class="n">app</span><span class="o">.</span><span class="na">gpsPowerMah</span> <span class="o">=</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">gpsTimeMs</span> <span class="o">*</span> <span class="n">mGpsPowerOn</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 统计所有sensor的情况</span>
            <span class="k">default</span><span class="o">:</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">sensorsCount</span> <span class="o">=</span> <span class="n">mSensors</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sensorsCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">Sensor</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mSensors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getHandle</span><span class="o">()</span> <span class="o">==</span> <span class="n">sensorHandle</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">app</span><span class="o">.</span><span class="na">sensorPowerMah</span> <span class="o">+=</span> <span class="o">(</span><span class="n">sensorTime</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="na">getPower</span><span class="o">())</span> <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
gps Sensor功耗 = (app.gpsTimeMs * mGpsPowerOn) / (1000<em>60</em>60)</p>

<h4 id="camera">1.7 Camera功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nf">CameraPowerCalculator</span><span class="o">(</span><span class="n">PowerProfile</span> <span class="n">profile</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mCameraPowerOnAvg</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_CAMERA</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateApp</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span> <span class="n">u</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 计算相机功耗.当前是基于典型相机应用平均功耗的粗略估算</span>
        <span class="kd">final</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Timer</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getCameraTurnedOnTimer</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">timer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">totalTime</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="na">getTotalTimeLocked</span><span class="o">(</span><span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">cameraTimeMs</span> <span class="o">=</span> <span class="n">totalTime</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">cameraPowerMah</span> <span class="o">=</span> <span class="o">(</span><span class="n">totalTime</span> <span class="o">*</span> <span class="n">mCameraPowerOnAvg</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">app</span><span class="o">.</span><span class="na">cameraTimeMs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">cameraPowerMah</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
Camera功耗 = (totalTime * mCameraPowerOnAvg) / (1000<em>60</em>60)</p>

<h4 id="flashlight">1.8 Flashlight功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nf">FlashlightPowerCalculator</span><span class="o">(</span><span class="n">PowerProfile</span> <span class="n">profile</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mFlashlightPowerOnAvg</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_FLASHLIGHT</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateApp</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Uid</span> <span class="n">u</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 计算闪光灯功耗. 基于闪光灯在短时间内平均功耗</span>
        <span class="kd">final</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">Timer</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getFlashlightTurnedOnTimer</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">timer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">totalTime</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="na">getTotalTimeLocked</span><span class="o">(</span><span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">flashlightTimeMs</span> <span class="o">=</span> <span class="n">totalTime</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">flashlightPowerMah</span> <span class="o">=</span> <span class="o">(</span><span class="n">totalTime</span> <span class="o">*</span> <span class="n">mFlashlightPowerOnAvg</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">app</span><span class="o">.</span><span class="na">flashlightTimeMs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">flashlightPowerMah</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
FlashLight功耗 = (totalTime * mFlashlightPowerOnAvg) / (1000<em>60</em>60)</p>

<h3 id="processmiscusage">二、硬件功耗processMiscUsage方法</h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processMiscUsage</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 用户功耗</span>
        <span class="n">addUserUsage</span><span class="o">();</span>
        <span class="c1">// 通话功耗</span>
        <span class="n">addPhoneUsage</span><span class="o">();</span>
        <span class="c1">// 屏幕功耗</span>
        <span class="n">addScreenUsage</span><span class="o">();</span>
        <span class="c1">// wifi功耗</span>
        <span class="n">addWiFiUsage</span><span class="o">();</span>
        <span class="c1">// 蓝牙功耗</span>
        <span class="n">addBluetoothUsage</span><span class="o">();</span>
        <span class="c1">// cpu空闲功耗（不包括cellular空闲时功耗）</span>
        <span class="n">addIdleUsage</span><span class="o">();</span>
        <span class="c1">// 仅支持wifi的设备,不计算radio的功耗</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mWifiOnly</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 移动radio功耗</span>
        <span class="n">addRadioUsage</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>公式：
硬件功耗 = 用户功耗 + 通话功耗 + 屏幕功耗 + wifi功耗 + 蓝牙功耗 + cpu空闲功耗 + 移动radio功耗</p>

<h4 id="user">2.1 User功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addUserUsage</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mUserSippers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">mUserSippers</span><span class="o">.</span><span class="na">keyAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="n">BatterySipper</span> <span class="n">bs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatterySipper</span><span class="o">(</span><span class="n">DrainType</span><span class="o">.</span><span class="na">USER</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">bs</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
        <span class="c1">// 将userSippers中功耗都合入bs</span>
        <span class="n">aggregateSippers</span><span class="o">(</span><span class="n">bs</span><span class="o">,</span> <span class="n">mUserSippers</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="s">"User"</span><span class="o">);</span>
        <span class="n">mUsageList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bs</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">aggregateSippers</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">bs</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">BatterySipper</span><span class="o">&gt;</span> <span class="n">from</span><span class="o">,</span> <span class="n">String</span> <span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">from</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">BatterySipper</span> <span class="n">wbs</span> <span class="o">=</span> <span class="n">from</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="c1">// from中功耗合入bs</span>
        <span class="n">bs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">wbs</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">bs</span><span class="o">.</span><span class="na">computeMobilemspp</span><span class="o">();</span>
        <span class="c1">// 计算总功耗</span>
        <span class="n">bs</span><span class="o">.</span><span class="na">sumPower</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
User功耗 = 每个user功耗之和</p>

<h4 id="phone">2.2 Phone功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addPhoneUsage</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">phoneOnTimeMs</span> <span class="o">=</span> <span class="n">mStats</span><span class="o">.</span><span class="na">getPhoneOnTime</span><span class="o">(</span><span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">phoneOnPower</span> <span class="o">=</span> <span class="n">mPowerProfile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_RADIO_ACTIVE</span><span class="o">)</span>
            <span class="o">*</span> <span class="n">phoneOnTimeMs</span> <span class="o">/</span> <span class="o">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">phoneOnPower</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addEntry</span><span class="o">(</span><span class="n">BatterySipper</span><span class="o">.</span><span class="na">DrainType</span><span class="o">.</span><span class="na">PHONE</span><span class="o">,</span> <span class="n">phoneOnTimeMs</span><span class="o">,</span> <span class="n">phoneOnPower</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>
<p>子公式：
Phone功耗 = mPowerProfile.getAveragePower(PowerProfile.POWER_RADIO_ACTIVE)
    * phoneOnTimeMs / (60<em>60</em>1000)</p>

<h4 id="screen">2.3 Screen功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// 设备运行时屏幕功耗是屏幕额外消费的功耗</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addScreenUsage</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">screenOnTimeMs</span> <span class="o">=</span> <span class="n">mStats</span><span class="o">.</span><span class="na">getScreenOnTime</span><span class="o">(</span><span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="n">power</span> <span class="o">+=</span> <span class="n">screenOnTimeMs</span> <span class="o">*</span> <span class="n">mPowerProfile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_SCREEN_ON</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">screenFullPower</span> <span class="o">=</span>
            <span class="n">mPowerProfile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_SCREEN_FULL</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">NUM_SCREEN_BRIGHTNESS_BINS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">screenBinPower</span> <span class="o">=</span> <span class="n">screenFullPower</span> <span class="o">*</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="o">)</span>
            <span class="o">/</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">NUM_SCREEN_BRIGHTNESS_BINS</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">brightnessTime</span> <span class="o">=</span> <span class="n">mStats</span><span class="o">.</span><span class="na">getScreenBrightnessTime</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">)</span>
            <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">p</span> <span class="o">=</span> <span class="n">screenBinPower</span><span class="o">*</span><span class="n">brightnessTime</span><span class="o">;</span>
        <span class="n">power</span> <span class="o">+=</span> <span class="n">p</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 转换为小时</span>
        <span class="n">power</span> <span class="o">/=</span> <span class="o">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">power</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addEntry</span><span class="o">(</span><span class="n">BatterySipper</span><span class="o">.</span><span class="na">DrainType</span><span class="o">.</span><span class="na">SCREEN</span><span class="o">,</span> <span class="n">screenOnTimeMs</span><span class="o">,</span> <span class="n">power</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
Screen功耗 = screenBinPower*brightnessTime + backlightPower</p>

<h4 id="wi-fi-1">2.4 Wi-Fi功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// 每个应用归于wifi活动。如果控制器报告能源信息，则归于wifi进程，因为正常的功耗统计时    分配到相应应用的。</span>
    <span class="c1">// 如果没有报告能源信息，则归于所有应用wifi运行时间和实际wifi到wifi子系统运行实际的差异</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addWiFiUsage</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">BatterySipper</span> <span class="n">bs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatterySipper</span><span class="o">(</span><span class="n">DrainType</span><span class="o">.</span><span class="na">WIFI</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">mWifiPowerCalculator</span><span class="o">.</span><span class="na">calculateRemaining</span><span class="o">(</span><span class="n">bs</span><span class="o">,</span> <span class="n">mStats</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span> <span class="n">mStatsType</span><span class="o">);</span>
        <span class="n">aggregateSippers</span><span class="o">(</span><span class="n">bs</span><span class="o">,</span> <span class="n">mWifiSippers</span><span class="o">,</span> <span class="s">"WIFI"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bs</span><span class="o">.</span><span class="na">totalPowerMah</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mUsageList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bs</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateRemaining</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span> <span class="n">stats</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span>
                   <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">ControllerActivityCounter</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="na">getWifiControllerActivity</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">idleTimeMs</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getIdleTimeCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">txTimeMs</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getTxTimeCounters</span><span class="o">()[</span><span class="mi">0</span><span class="o">].</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">rxTimeMs</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getRxTimeCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">wifiRunningTimeMs</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span>
            <span class="o">(</span><span class="n">idleTimeMs</span> <span class="o">+</span> <span class="n">rxTimeMs</span> <span class="o">+</span> <span class="n">txTimeMs</span><span class="o">)</span> <span class="o">-</span> <span class="n">mTotalAppRunningTime</span><span class="o">);</span>

        <span class="kt">double</span> <span class="n">powerDrainMah</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getPowerCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">)</span>
            <span class="o">/</span> <span class="o">(</span><span class="kt">double</span><span class="o">)(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">powerDrainMah</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 针对不报告功率的发射器计算功耗</span>
        <span class="n">powerDrainMah</span> <span class="o">=</span> <span class="o">((</span><span class="n">idleTimeMs</span> <span class="o">*</span> <span class="n">mIdleCurrentMa</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">txTimeMs</span> <span class="o">*</span> <span class="n">mTxCurrentMa</span><span class="o">)</span>
            <span class="o">+</span> <span class="o">(</span><span class="n">rxTimeMs</span> <span class="o">*</span> <span class="n">mRxCurrentMa</span><span class="o">))</span> <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">app</span><span class="o">.</span><span class="na">wifiPowerMah</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">powerDrainMah</span> <span class="o">-</span> <span class="n">mTotalAppPowerDrain</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
Wi-Fi功耗 = ((idleTimeMs * mIdleCurrentMa) + (txTimeMs * mTxCurrentMa)
            + (rxTimeMs * mRxCurrentMa)) / (1000<em>60</em>60)</p>

<h4 id="bluetooth-1">2.5 Bluetooth功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// 蓝牙使用不归因于任何应用，所以整个责任归于蓝牙类别</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addBluetoothUsage</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">BatterySipper</span> <span class="n">bs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatterySipper</span><span class="o">(</span><span class="n">BatterySipper</span><span class="o">.</span><span class="na">DrainType</span><span class="o">.</span><span class="na">BLUETOOTH</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">mBluetoothPowerCalculator</span><span class="o">.</span><span class="na">calculateRemaining</span><span class="o">(</span><span class="n">bs</span><span class="o">,</span> <span class="n">mStats</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span>
            <span class="n">mStatsType</span><span class="o">);</span>
        <span class="n">aggregateSippers</span><span class="o">(</span><span class="n">bs</span><span class="o">,</span> <span class="n">mBluetoothSippers</span><span class="o">,</span> <span class="s">"Bluetooth"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bs</span><span class="o">.</span><span class="na">totalPowerMah</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mUsageList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bs</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateRemaining</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span> <span class="n">stats</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span>
                   <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">BatteryStats</span><span class="o">.</span><span class="na">ControllerActivityCounter</span> <span class="n">counter</span> <span class="o">=</span>
            <span class="n">stats</span><span class="o">.</span><span class="na">getBluetoothControllerActivity</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">idleTimeMs</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getIdleTimeCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">txTimeMs</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getTxTimeCounters</span><span class="o">()[</span><span class="mi">0</span><span class="o">].</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">rxTimeMs</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getRxTimeCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">totalTimeMs</span> <span class="o">=</span> <span class="n">idleTimeMs</span> <span class="o">+</span> <span class="n">txTimeMs</span> <span class="o">+</span> <span class="n">rxTimeMs</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">powerMah</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getPowerCounter</span><span class="o">().</span><span class="na">getCountLocked</span><span class="o">(</span><span class="n">statsType</span><span class="o">)</span>
             <span class="o">/</span> <span class="o">(</span><span class="kt">double</span><span class="o">)(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">powerMah</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 计算不上报功率的设备</span>
        <span class="n">powerMah</span> <span class="o">=</span> <span class="o">((</span><span class="n">idleTimeMs</span> <span class="o">*</span> <span class="n">mIdleMa</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">rxTimeMs</span> <span class="o">*</span> <span class="n">mRxMa</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">txTimeMs</span> <span class="o">*</span> <span class="n">mTxMa</span><span class="o">))</span>
            <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 减去应用的功耗</span>
        <span class="n">powerMah</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">powerMah</span> <span class="o">-</span> <span class="n">mAppTotalPowerMah</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">bluetoothPowerMah</span> <span class="o">=</span> <span class="n">powerMah</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">bluetoothRunningTimeMs</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">totalTimeMs</span> <span class="o">-</span> <span class="n">mAppTotalTimeMs</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
Bluetooth功耗 = ((idleTimeMs * mIdleMa) + (rxTimeMs * mRxMa) + (txTimeMs *
    mTxMa)) / (1000<em>60</em>60)</p>

<h4 id="cpu-idle">2.6 CPU Idle功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// 当设备暂停或空闲时，计算基本的功耗</span>
    <span class="c1">// 设备在处于最低功耗时绘制POWER_CPU_IDLE功耗</span>
    <span class="c1">// 设备持有一个wakelock时绘制POWER_CPU_IDLE + POWER_CPU_AWAKE功耗</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addIdleUsage</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">suspendPowerMaMs</span> <span class="o">=</span> <span class="o">(</span><span class="n">mTypeBatteryRealtimeUs</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">*</span>
            <span class="n">mPowerProfile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_CPU_IDLE</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">idlePowerMaMs</span> <span class="o">=</span> <span class="o">(</span><span class="n">mTypeBatteryUptimeUs</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">*</span>
            <span class="n">mPowerProfile</span><span class="o">.</span><span class="na">getAveragePower</span><span class="o">(</span><span class="n">PowerProfile</span><span class="o">.</span><span class="na">POWER_CPU_AWAKE</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">totalPowerMah</span> <span class="o">=</span> <span class="o">(</span><span class="n">suspendPowerMaMs</span> <span class="o">+</span> <span class="n">idlePowerMaMs</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">totalPowerMah</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addEntry</span><span class="o">(</span><span class="n">BatterySipper</span><span class="o">.</span><span class="na">DrainType</span><span class="o">.</span><span class="na">IDLE</span><span class="o">,</span> <span class="n">mTypeBatteryRealtimeUs</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">,</span> <span class="n">totalPowerMah</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
CPU Idle功耗 = (suspendPowerMaMs + idlePowerMaMs) / (60 * 60 * 1000)</p>

<h4 id="mobile-radio-1">2.7 Mobile Radio功耗</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addRadioUsage</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">BatterySipper</span> <span class="n">radio</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatterySipper</span><span class="o">(</span><span class="n">BatterySipper</span><span class="o">.</span><span class="na">DrainType</span><span class="o">.</span><span class="na">CELL</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">mMobileRadioPowerCalculator</span><span class="o">.</span><span class="na">calculateRemaining</span><span class="o">(</span><span class="n">radio</span><span class="o">,</span> <span class="n">mStats</span><span class="o">,</span> <span class="n">mRawRealtimeUs</span><span class="o">,</span> <span class="n">mRawUptimeUs</span><span class="o">,</span>
            <span class="n">mStatsType</span><span class="o">);</span>
        <span class="n">radio</span><span class="o">.</span><span class="na">sumPower</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">radio</span><span class="o">.</span><span class="na">totalPowerMah</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mUsageList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">radio</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculateRemaining</span><span class="o">(</span><span class="n">BatterySipper</span> <span class="n">app</span><span class="o">,</span> <span class="n">BatteryStats</span> <span class="n">stats</span><span class="o">,</span> <span class="kt">long</span> <span class="n">rawRealtimeUs</span><span class="o">,</span>
                       <span class="kt">long</span> <span class="n">rawUptimeUs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">signalTimeMs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">noCoverageTimeMs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mPowerBins</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">strengthTimeMs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="na">getPhoneSignalStrengthTime</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="n">statsType</span><span class="o">)</span>
            <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">strengthTimeMs</span> <span class="o">*</span> <span class="n">mPowerBins</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">/</span> <span class="o">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="o">);</span>
        <span class="n">power</span> <span class="o">+=</span> <span class="n">p</span><span class="o">;</span>
        <span class="n">signalTimeMs</span> <span class="o">+=</span> <span class="n">strengthTimeMs</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">noCoverageTimeMs</span> <span class="o">=</span> <span class="n">strengthTimeMs</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">scanningTimeMs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="na">getPhoneSignalScanningTime</span><span class="o">(</span><span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="n">statsType</span><span class="o">)</span>
            <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">scanningTimeMs</span> <span class="o">*</span> <span class="n">mPowerScan</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="o">);</span>
        <span class="n">power</span> <span class="o">+=</span> <span class="n">p</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">radioActiveTimeMs</span> <span class="o">=</span> <span class="n">mStats</span><span class="o">.</span><span class="na">getMobileRadioActiveTime</span><span class="o">(</span><span class="n">rawRealtimeUs</span><span class="o">,</span> <span class="n">statsType</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">remainingActiveTimeMs</span> <span class="o">=</span> <span class="n">radioActiveTimeMs</span> <span class="o">-</span> <span class="n">mTotalAppMobileActiveMs</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">remainingActiveTimeMs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">power</span> <span class="o">+=</span> <span class="o">(</span><span class="n">mPowerRadioOn</span> <span class="o">*</span> <span class="n">remainingActiveTimeMs</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">power</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">signalTimeMs</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">app</span><span class="o">.</span><span class="na">noCoveragePercent</span> <span class="o">=</span> <span class="n">noCoverageTimeMs</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="n">signalTimeMs</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileActive</span> <span class="o">=</span> <span class="n">remainingActiveTimeMs</span><span class="o">;</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileActiveCount</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="na">getMobileRadioActiveUnknownCount</span><span class="o">(</span><span class="n">statsType</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">mobileRadioPowerMah</span> <span class="o">=</span> <span class="n">power</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>子公式：
Mobile Radio功耗 = strengthOnPower + scanningPower + remainingActivePower</p>

<h3 id="section">三、总功耗</h3>

<p>总功耗 = 软件功耗 + 硬件功耗</p>

<p><img src="https://xiezeyangcn.github.io/xzyblog.github.io/assets/images/2017-12-01-power-calculator/calculate_hardware_power.png" alt="" />
<img src="https://xiezeyangcn.github.io/xzyblog.github.io/assets/images/2017-12-01-power-calculator/calculate_hardware_power.png" alt="" /></p>
